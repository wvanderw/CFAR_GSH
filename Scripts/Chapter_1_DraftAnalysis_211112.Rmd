---
title: "Chapter_1_DraftAnalysis_211112"
author: "Wade VanderWright"
date: "12/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

```

## Set up
```{r}
##Install packages
#install.packages(c('ape','phytools','nlme','tidyverse','gieger','xlsx','here','readxl','brms','rstan','gdata','bayesplot','StanHeaders', 'caper'))


##Load Packages
library(ape)
library(phytools)
library(nlme)
#library(tidyverse)
library(ggplot2)
library(dplyr)
library(geiger)
#library(caper)
#library(xlsx)
library(here)
library(readxl)
library(StanHeaders)
library(brms)

library(rstan)
library(gdata)
library(bayesplot)


##Preload functions
# 'Not in' function
'%nin%' <- Negate('%in%')

# Caudal fin aspect ratio function
caudal_fin <- function(height, area) {
  aspect_ratio <- (height^2 / area)
  return(aspect_ratio)
}

#Centering data function
center_scale <- function(x, y){
  scale(x, center = y, scale = FALSE)
}

#Run this and skip to line 348
load(here('./Data/Output/CurrentDataState.RData'))


```

##Load & Clean Data 
```{r}
getwd()

#load last workspace above and skip this ^^^^
#

# GSH Data ####
GSH_df <- read.csv(here('Data', 'Input', 'SharkGillSlitActivity210331 - Sheet1.csv'), header = T)
#drop NAs
GSH_df <- GSH_df %>% drop_na(GS1_proportionTL)
#create binomial
GSH_df <- GSH_df %>% 
  rowwise() %>% 
  mutate(Binomial = paste(Genus, Species, sep = '_'))
#force as character
GSH_df$Binomial <- as.character(GSH_df$Binomial)
#arrange by binomial
GSH_df <- GSH_df %>% 
  arrange(Binomial)
#Calculate the mean GSH per species
GSH_df <- GSH_df %>% 
  rowwise() %>% 
  mutate("MeanGSH" = mean(c(GS1_proportionTL, GS2_proportionTL, GS3_proportionTL, GS4_proportionTL, GS5_proportionTL, GS6_proportionTL, GS7_proportionTL), na.rm = TRUE))
#create Caudal fin aspect ratios and Log10 columns for desired variables 
GSH_df <- GSH_df %>%
  rowwise() %>% 
  mutate("CaudalAspect_proportion_TL" = caudal_fin(TailHeight_proportionTL, TailArea_proportionTL)) %>% 
  mutate(Log10MeanGSH = log10(MeanGSH)) %>% 
  mutate(Log10CFAR = log10(CaudalAspect_proportion_TL))
#update taxonomy to match
GSH_df[(GSH_df$Binomial == 'Deania_quadrispinosum'), 'Binomial'] <- 'Deania_quadrispinosa'
GSH_df[(GSH_df$Binomial == 'Ctenacis_fehlmani'), 'Binomial'] <- 'Ctenacis_fehlmanni' 
GSH_df[(GSH_df$Binomial == 'Hemitriakis_leucoperitera'), 'Binomial'] <- 'Hemitriakis_leucoperiptera'
GSH_df[(GSH_df$Binomial == 'Lamiopsis_temmincki'), 'Binomial'] <- 'Lamiopsis_temminckii'
GSH_df[(GSH_df$Binomial == 'Carcharhinus_perezi'), 'Binomial'] <- 'Carcharhinus_perezii'
GSH_df[(GSH_df$Binomial == 'Chiloscyllium_hasselti'), 'Binomial'] <- 'Chiloscyllium_hasseltii'


# Depth and habitat Data####
#load data
Habitat <- read_excel(here('./Data/Input/Habitat_species_corrected_210512.xlsx'), sheet = "Current")
#update taxonomy to match
Habitat[(Habitat$Genus_species == 'Carcharhinus_perezi'), 'Genus_species'] <- 'Carcharhinus_perezii'
Habitat[(Habitat$Genus_species == 'Chiloscyllium_hasselti'), 'Genus_species'] <- 'Chiloscyllium_hasseltii'
#filter to match species
Habitat <- Habitat %>% 
  filter(Genus_species %in% GSH_df$Binomial)
#arrange by binomial
Habitat <- Habitat %>% 
  arrange(Genus_species)
#save missing species for later
missing.habitat <- GSH_df[(GSH_df$Binomial %nin% Habitat$Genus_species),]
#trim unused columns from habitat sheet
Habitat <- Habitat[,c(10,22,23,29,33,34)]
#join dataframes
GSH_df <- left_join(GSH_df, Habitat, by = c('Binomial' = 'Genus_species'))
GSH_df$MaxLinearDimension <- as.numeric(GSH_df$MaxLinearDimension)
#Log the maximum size column
GSH_df <- GSH_df %>% 
  rowwise() %>% 
  mutate(Log10MaxSize = log10(MaxLinearDimension))
#center the Log10 Mean GSH column
y <- mean(GSH_df$Log10MeanGSH)
GSH_df$Log10MeanGSH_centered <- center_scale(GSH_df$Log10MeanGSH, y)
#



###Phylo Data####
#read in the 10000 trees
FullTree <- read.nexus(here('./Data/Input/10.cal.tree.nex'))
#se the seed for reproduciblility
set.seed(11)
#sample out a tree
SampleTree <- sample(FullTree, 1)
SampleTree <- SampleTree$UNTITLED
#check if tips are binary
is.binary(SampleTree)
#check where the tree and dataset differ
namedrops <- name.check(SampleTree, GSH_df, GSH_df$Binomial)
#drop the tips that are in the tree and not in the data (all the rays)
SampleTree <- drop.tip(SampleTree, namedrops$tree_not_data)
#drop the species in the dataset that are not in the tree
GSH_df_pgls <- subset(GSH_df, GSH_df$Binomial %nin% namedrops$data_not_tree) 

#center the Log10 Max Size column
z <- mean(GSH_df_pgls$Log10MaxSize)
GSH_df_pgls$Log10MaxSize_centered <- center_scale(GSH_df_pgls$Log10MaxSize, z)
GSH_df_pgls$Log10MaxSize_centered <- as.numeric(GSH_df_pgls$Log10MaxSize_centered)

#change depth data to numeric (will have to drop NAs in depth models)
GSH_df_pgls$DepthMax_m_text <- as.numeric(GSH_df_pgls$DepthMax_m_text)

GSH_df_pgls$DepthMin_m_text <- as.numeric(GSH_df_pgls$DepthMin_m_text)

#change habitats to factor
GSH_df_pgls$PrimaryHabitat <- as.factor(GSH_df_pgls$PrimaryHabitat)
#add contrast structure
contrasts(GSH_df_pgls$PrimaryHabitat) = contr.treatment(3)

#order dataframe to match tree tip labels
target <- SampleTree$tip.label

GSH_df_pgls <- GSH_df_pgls %>% 
  arrange(factor(GSH_df_pgls$Binomial, levels = target))

#covariance matrix
A <- ape::vcv.phylo(SampleTree, corr = TRUE)
B <- ape::vcv(SampleTree, corr = TRUE)


```

## Plot the Tree
```{r}
plot(SampleTree, type = 'fan', show.tip=F, edge.color = rainbow(1200))
```

## pgls without brms or multiple levels
Fixed the 'form' argument to match the tree to the data frame structure. The default 'form = ~1' just takes the speicies as they appear in the data frame. Now the slope estimate matches the brms model (with tree) but the lambda is still ~0.7.
https://stackoverflow.com/questions/63138372/error-running-pgls-in-ape-no-covariate-specified

```{r}
pglsMod1 <- gls(Log10CFAR ~ Log10MeanGSH_centered, correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), data = GSH_df_pgls, method = "ML")

summary(pglsMod1)

```

```{r}
plot(Log10CFAR ~ Log10MeanGSH_centered, data = GSH_df_pgls, pch=20)
abline(a = coef(pglsMod1)[1], b = coef(pglsMod1)[2], col = 6, lw = 2)
```

## pgls with body size
```{r}
pglsMod2 <- gls(Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered, correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), data = GSH_df_pgls, method = "ML")

summary(pglsMod2)
```

```{r}
plot(Log10CFAR ~ Log10MeanGSH_centered, data = GSH_df_pgls, pch = 20)

abline(a = coef(pglsMod2)[1], b = coef(pglsMod2)[2], col = 6, lw = 2)
```

## pgls with body size (no interaction)
```{r}
pglsMod3 <- gls(Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered, correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), data = GSH_df_pgls, method = "ML")

summary(pglsMod3)
```

```{r}
plot(Log10CFAR ~ Log10MeanGSH_centered, data = GSH_df_pgls, pch = 20)

abline(a = coef(pglsMod3)[1], b = coef(pglsMod3)[2], col = 6, lw = 2)
```


## pgls with body size (no interaction; intercept only)

```{r}
pglsMod4 <- gls(Log10CFAR ~ Log10MeanGSH_centered + (1|Log10MaxSize_centered), correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), data = GSH_df_pgls, method = "ML",
                control = list(singular.ok = TRUE))

summary(pglsMod4)
```

```{r}
plot(Log10CFAR ~ Log10MeanGSH_centered, data = GSH_df_pgls, pch = 20)

abline(a = coef(pglsMod4)[1], b = coef(pglsMod4)[2], col = 6, lw = 2)
```

##pgls with habitat type (no interation)
```{r}
pglsMod5 <- gls(Log10CFAR ~ Log10MeanGSH_centered + PrimaryHabitat, correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), data = GSH_df_pgls, method = "ML")

summary(pglsMod5)
```

```{r}
plot(Log10CFAR ~ Log10MeanGSH_centered, data = GSH_df_pgls, pch = 20)

abline(a = coef(pglsMod5)[1], 
       b = coef(pglsMod5)[2], 
       col = 6, lw = 2)

abline(a = coef(pglsMod5)[1] + coef(pglsMod5)[3], 
       b = coef(pglsMod5)[2], col = 'blue', lw =2)
       
abline(a = (coef(pglsMod5)[1] + coef(pglsMod5)[4]), 
       b = coef(pglsMod5)[2], 
       col = 'green', lw =2)

```


##pgls with habitat interaction
```{r}
pglsMod6 <- gls(Log10CFAR ~ Log10MeanGSH_centered * PrimaryHabitat, correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), data = GSH_df_pgls, method = "ML",
                control = list(singular.ok = TRUE))

summary(pglsMod6)
```


```{r}

plot(Log10CFAR ~ Log10MeanGSH_centered, data = GSH_df_pgls, pch = 20)

abline(a = coef(pglsMod6)[1], 
       b = coef(pglsMod6)[2], 
       col = 6, lw = 2)

abline(a = coef(pglsMod6)[1] + coef(pglsMod6)[3], 
       b = coef(pglsMod6)[2] + coef(pglsMod6)[5], 
       col = 'blue', lw =2)
       
abline(a = (coef(pglsMod6)[1] + coef(pglsMod6)[4]), 
       b = coef(pglsMod5)[2] + coef(pglsMod6)[6], 
       col = 'green', lw =2)

```



## BRMS no tree , no interaction with body size
```{r}
Plain_prior <- get_prior(Log10CFAR ~ Log10MeanGSH_centered,
                    data = GSH_df_pgls,
                    family = gaussian())


Model_plain <- brm(Log10CFAR ~ Log10MeanGSH_centered,
                    data = GSH_df_pgls,
                    family = gaussian(),
                    #data2 = list(A = A), #don't need for this model
                    prior = Plain_prior
                    )

summary(Model_plain)
```

```{r}
plot(conditional_effects(Model_plain), points = TRUE)

```

## BRMS no tree, with interaction with body size
```{r}
Size_prior <- get_prior(Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered,
                    data = GSH_df_pgls,
                    family = gaussian())

Model_size <- brm(Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered,
                    data = GSH_df_pgls,
                    family = gaussian(),
                    #data2 = list(A = A), #don't need for this model
                    prior = Size_prior
                    )

summary(Model_size)

```


```{r}
plot(conditional_effects(Model_size), points = TRUE) #hit enter in the console



```

## BRMS no tree, with body size as additional predictor (no interaction)
```{r}
Size_prior_2 <- get_prior(Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered,
                    data = GSH_df_pgls,
                    family = gaussian())

Model_size_2 <- brm(Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered,
                    data = GSH_df_pgls,
                    family = gaussian(),
                    #data2 = list(A = A), #don't need for this model
                    prior = Size_prior_2)

summary(Model_size_2)
```

```{r}
plot(conditional_effects(Model_size_2), points = TRUE) #hit enter in the console



```

## BRMS no tree, with body size as additional predictor (intercept only)
```{r}
Size_prior_3 <- get_prior(Log10CFAR ~ Log10MeanGSH_centered + (1|Log10MaxSize_centered),
                    data = GSH_df_pgls,
                    family = gaussian())

Model_size_3 <- brm(Log10CFAR ~ Log10MeanGSH_centered + (1|Log10MaxSize_centered),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    #data2 = list(A = A), #don't need for this model
                    prior = Size_prior_3,
                    control = list(adapt_delta = 0.9))

summary(Model_size_3)
```

```{r}
plot(conditional_effects(Model_size_3), points = TRUE) #hit enter in the console



```

##BRMS with habitat type (No interaction)
```{r}
habitat_prior <- get_prior(Log10CFAR ~ Log10MeanGSH_centered + PrimaryHabitat,
                    data = GSH_df_pgls,
                    family = gaussian())

#run time was about 30 minutes
habitat_model <- brm(Log10CFAR ~ Log10MeanGSH_centered + PrimaryHabitat,
                    data = GSH_df_pgls,
                    family = gaussian(),
                    prior = habitat_prior,
                    cores = 2)

summary(habitat_model)


```


```{r}
plot(conditional_effects(habitat_model), points = TRUE)

```

```{r}
plot(habitat_model, N=2, ask = F)
```


```{r}
hyp <- "sd_Binomial__Intercept^2 / (sd_Binomial__Intercept^2 + sigma^2) = 0"
(hyp <- hypothesis(Model_simple, hyp, class = NULL))
```

```{r}
plot(hyp)
```

##BRMS with habitat type interaction
```{r}
habitat_prior2 <- get_prior(Log10CFAR ~ Log10MeanGSH_centered * PrimaryHabitat,
                    data = GSH_df_pgls,
                    family = gaussian())

#run time was about 30 minutes
habitat_model_2 <- brm(Log10CFAR ~ Log10MeanGSH_centered * PrimaryHabitat,
                    data = GSH_df_pgls,
                    family = gaussian(),
                    prior = habitat_prior2,
                    cores = 2)

summary(habitat_model_2)


```


```{r}
plot(conditional_effects(habitat_model_2), points = TRUE)

```

```{r}
plot(habitat_model_2, N=2, ask = F)
```


## BRMS with tree, no interation with body size
```{r}
Simple_prior <- get_prior(Log10CFAR ~ Log10MeanGSH_centered + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A))

#run time was about 30 minutes
Model_simple <- brm(Log10CFAR ~ Log10MeanGSH_centered + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A),
                    prior = Simple_prior,
                    cores = 2)

summary(Model_simple)

#center the MeanGSH on mean value (close to a log or whole number)

```


```{r}
plot(conditional_effects(Model_simple), points = TRUE)

```

```{r}
plot(Model_simple, N=2, ask = F)

```


```{r}
hyp <- "sd_Binomial__Intercept^2 / (sd_Binomial__Intercept^2 + sigma^2) = 0"
(hyp <- hypothesis(Model_simple, hyp, class = NULL))
```

```{r}
plot(hyp)
```


## BRMS with tree AND interaction with body size
```{r}
BS_prior <- get_prior(Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A))

Model_BS <- brm(Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A),
                    prior = BS_prior,
                sample_prior = TRUE, chains = 4, cores = 2)

summary(Model_BS)
```


```{r}
plot(conditional_effects(Model_BS), points = TRUE) #hit enter in console

```


```{r}
plot(Model_BS, N=2, ask = F)
```

```{r}
hyp <- 'sd_Binomial__Intercept^2 / (sd_Binomial__Intercept^2 + sigma^2) = 0'
(hyp <- hypothesis(Model_BS, hyp, class = NULL))
```
```{r}
plot(hyp)
```

##BRMS with size and tree 
```{r}
BS_prior2 <- get_prior(Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A))

Model_BS2 <- brm(Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A),
                    prior = BS_prior2,
                sample_prior = TRUE, chains = 4, cores = 2)

summary(Model_BS2)
```


## STAN model comparison
```{r}
##Data prep #add in priors from brms?

y <- GSH_df_pgls$Log10CFAR
x <- c(GSH_df_pgls$Log10MeanGSH_centered)
N <- length(GSH_df_pgls$Binomial)

stan_data <- list(N = N, x = x, y = y)
  
## Stan Model 1 -- Log10CFAR ~ Log10MeanGSH_centered
StanModel1 <- stan_model(file = here('Scripts', 'StanModel1.stan'))

fit1 <- stan(file = './StanModel1.stan', data = stan_data, warmup = 500, iter = 1000, chains = 4, cores = 2, thin = 1)
  

```


```{r}
posterior <- extract(fit1)
cat(c('alpha', 'beta', 'sigma', 'lp__\n', mean(posterior$alpha), mean(posterior$beta), mean(posterior$sigma), mean(posterior$lp__)))

```

```{r}
summary(pglsMod1)
```



```{r}
pglsMod2 <- gls(y ~ x, correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), data = GSH_df_pgls, method = "ML")

plot(y ~ x, pch = 20)
abline(a = coef(pglsMod2)[1], b = coef(pglsMod2)[2], col = 2, lty = 2, lw = 5)

for (i in 1:500) {
 abline(posterior$alpha[i], posterior$beta[i], col = "gray", lty = 1)
}

abline(mean(posterior$alpha), mean(posterior$beta), col = 6, lw = 2)
```

## STAN model comparison 2
```{r}
## Stan Model 2 -- Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered

#data matrix
data_matrix_2 <- model.matrix(~ Log10MeanGSH_centered * Log10MaxSize_centered, data = GSH_df_pgls)

#data
N <- length(GSH_df_pgls$Binomial)
y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_2
K <- ncol(x)

stan_data2 <- list(N=N,K=K,y=y,x=x)


## Stan Model 2 -- Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered
StanModel2 <- stan_model(file = here('Scripts', 'StanModel2.stan'))

fit2 <- stan(file = './StanModel2.stan', data = stan_data2, warmup = 500, iter = 1000, chains = 4, cores = 2, thin = 1, control = list('max_treedepth' = 10))
  

```

```{r}
fit2
posterior2 <- as.data.frame(fit2)
```

```{r}

plot(GSH_df_pgls$Log10CFAR ~ GSH_df_pgls$Log10MeanGSH_centered, pch = 20)




for (i in 1:500) {
 abline(posterior2[i,1], posterior2[i,2], col = "gray", lty = 1)
}

abline(mean(posterior2[,1]), mean(posterior2[,2]), col = 'blue', lw = 2)

```

## STAN model comparison 3
```{r}
## Stan Model 3 -- Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered

#not used
data_matrix_3 <- model.matrix(~ Log10MeanGSH_centered + Log10MaxSize_centered, data = GSH_df_pgls)

#data
N <- length(GSH_df_pgls$Binomial)
y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_3
K <- ncol(x)

stan_data3 <- list(N=N,K=K,y=y,x=x)

#prior
stan2_prior <- Size_prior_2

## Stan Model 2 -- Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered
StanModel2 <- stan_model(file = here('Scripts', 'StanModel2.stan'))

fit3 <- stan(file = './StanModel2.stan', data = stan_data3, warmup = 500, iter = 1000, chains = 4, cores = 4, thin = 1)
  

```


```{r}
posterior3 <- as.data.frame(fit3)
```

```{r}
plot(GSH_df_pgls$Log10CFAR ~ GSH_df_pgls$Log10MeanGSH_centered, pch = 20)


for (i in 1:500) {
 abline(posterior3[i,1], posterior3[i,2], col = "gray", lty = 1)
}

abline(mean(posterior3[,1]), mean(posterior3[,2]), col = 'blue', lw = 2)

```


##STAN Model 4 (CFAR ~ GSH + tree)

```{r}
data_matrix_4 <- model.matrix(~ Log10MeanGSH_centered, data = GSH_df_pgls)

y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_4
N <- length(GSH_df_pgls$Binomial)
K <- ncol(x)
d_mat <- diag(1, 456, 456)



stan_data4 <- list(N = N, x = x, y = y, K =K, d_mat = d_mat, A = A)


fit4 <- stan(file = './StanModel3.stan', data = stan_data4, warmup = 500, iter = 1000, chains = 4, cores = 4, thin = 10)
  

```

```{r}
posterior4 <- as.data.frame(fit4)
```


```{r}
plot(GSH_df_pgls$Log10CFAR ~ GSH_df_pgls$Log10MeanGSH_centered, pch = 20)


for (i in 1:100) {
 abline(posterior4[i,1], posterior4[i,2], col = "gray", lty = 1)
}

abline(mean(posterior4[,1]), mean(posterior4[,2]), col = 'blue', lw = 2)

abline(a = coef(pglsMod1)[1], b = coef(pglsMod1)[2], col = 2, lty = 2, lw = 5)
```


##STAN Model 5 (CFAR ~ GSH * Max Size + tree)
```{r}
y <- GSH_df_pgls$Log10CFAR
x <- matrix(c(GSH_df_pgls$Log10MeanGSH_centered, GSH_df_pgls$Log10MaxSize_centered,(GSH_df_pgls$Log10MeanGSH_centered*GSH_df_pgls$Log10MaxSize_centered)), ncol = 3, byrow = F)
N <- length(GSH_df_pgls$Binomial)
K <- ncol(x)
d_mat <- diag(1, 456, 456)



stan_data5 <- list(N = N, x = x, y = y, K =K, d_mat = d_mat, A = A)
  
## Stan Model 4 -- Log10CFAR ~ Log10MeanGSH_centered + tree
StanModel5 <- stan_model(file = here('Scripts', 'StanModel3.stan'))

fit5 <- stan(file = './StanModel3.stan', data = stan_data5, warmup = 500, iter = 1000, chains = 4, cores = 4, thin = 10,
             pars = c("alpha", "beta"))
  

```

```{r}
fit5
posterior5 <- as.data.frame(fit5)
```


#STAN Model 6 (CFAR ~ GSH + PrimaryHabitat)
```{r}
## Stan Model 6 -- Log10CFAR ~ Log10MeanGSH_centered + PrimaryHabitat

#data
N <- length(GSH_df_pgls$Binomial)
K <- 2
y <- GSH_df_pgls$Log10CFAR
x <- matrix(c(GSH_df_pgls$Log10MeanGSH_centered, GSH_df_pgls$PrimaryHabitat), ncol = 2, byrow = F)

stan_data6 <- list(N=N,K=K,y=y,x=x)


fit6 <- stan(file = './StanModel2.stan', data = stan_data6, warmup = 500, iter = 1000, chains = 4, cores = 4, thin = 1)
  

```


```{r}
fit6
posterior6 <- as.data.frame(fit6)
```

```{r}
plot(GSH_df_pgls$Log10CFAR ~ GSH_df_pgls$Log10MeanGSH_centered, pch = 20)


for (i in 1:500) {
 abline(posterior$alpha[i], posterior$beta[i], col = adjustcolor("gray", alpha = 0.05), lty = 1)
}



for (i in 1:500) {
 abline(posterior2$alpha[i], posterior2$beta[i], col = adjustcolor("gray", alpha = 0.05), lty = 1)
}



for (i in 1:500) {
 abline(posterior3$alpha[i], posterior3$beta[i], col = adjustcolor("gray", alpha = 0.05), lty = 1)
}

abline(mean(posterior$alpha), mean(posterior$beta), col = 6, lw = 2)

abline(mean(posterior2$alpha), mean(posterior2$beta), col = 'blue', lw = 2)

abline(mean(posterior6$alpha), mean(posterior6[,2]), col = 'green', lw = 2)


abline(a = coef(pglsMod2)[1], b = coef(pglsMod2)[2], col = 2, lty = 2, lw = 5)
```

#STAN Model 7 (CFAR ~ GSH * PrimaryHabitat)
```{r}
## Stan Model 6 -- Log10CFAR ~ Log10MeanGSH_centered + PrimaryHabitat

#data
N <- length(GSH_df_pgls$Binomial)
K <- 3
y <- GSH_df_pgls$Log10CFAR
x <- matrix(c(GSH_df_pgls$Log10MeanGSH_centered, GSH_df_pgls$PrimaryHabitat,(GSH_df_pgls$Log10MeanGSH_centered* GSH_df_pgls$PrimaryHabitat)), ncol = 3, byrow = F)

stan_data7 <- list(N=N,K=K,y=y,x=x)


fit7 <- stan(file = './StanModel2.stan', data = stan_data6, warmup = 500, iter = 1000, chains = 4, cores = 4, thin = 1)
  

```


```{r}
fit7
posterior7 <- extract(fit7)
```

#Lambda and residuals (quick and dirty)


Model 5 - CFAR ~ GSH + Phylogeny

```{r}
mod5 <- phyl.resid(SampleTree, GSH_df_pgls$Log10MeanGSH_centered, GSH_df_pgls$Log10CFAR, method = 'lambda')
```

Model 6 - CFAR ~ GSH * Max Size + Phylogeny 

```{r}
mod6 <- phyl.resid(SampleTree, matrix(c(GSH_df_pgls$Log10MeanGSH_centered, GSH_df_pgls$Log10MaxSize_centered,(GSH_df_pgls$Log10MeanGSH_centered*GSH_df_pgls$Log10MaxSize_centered)), ncol = 3, byrow = F), GSH_df_pgls$Log10CFAR, method = 'lambda')
```

Model 7 - CFAR ~ GSH + Max Size + Phylogeny 

```{r}
mod7 <- phyl.resid(SampleTree, matrix(c(GSH_df_pgls$Log10MeanGSH_centered, GSH_df_pgls$Log10MaxSize_centered), ncol = 2, byrow = F), GSH_df_pgls$Log10CFAR, method = 'lambda')
```


#loo analysis


```{r}
loo1 <- add_criterion(mean_no_phylo_brms, "loo")
loo2 <- add_criterion(mean_no_phylo_brms_int, "loo")

loo_list <- list(loo1, loo2)
loo_model_weights(loo_list)
loo_compare(loo_list)
```




### Save the environment
```{r}
save.image(here('./Data/Output/CurrentDataState.RData'))
```

