---
title: "01a_PhysicalSpecimens"
author: "Wade VanderWright"
date: '2022-06-20'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 01a_PhysicalSpecimens - Comparison of physical specimens to field guide illustations
## VanderWright, WJ
## June 20, 2022

#Fix binomial issues
```{r}
fix_list <- PhysSpec[which(PhysSpec$Binomial %nin% GSH_df_pgls$Binomial),]
fix_list <- fix_list %>% 
  distinct(Binomial, .keep_all = T)

PhysSpec[(PhysSpec$Binomial == 'Eusphyrna_blochii'), 'Binomial'] = "Eusphyra_blochii"
PhysSpec[(PhysSpec$Binomial == 'Centrophorus_uyato'), 'Binomial'] = "Centrophorus_uyato" #drop/not in 2013
PhysSpec[(PhysSpec$Binomial == 'Hemipristis_elongatus'), 'Binomial'] = "Hemipristis_elongata"
PhysSpec[(PhysSpec$Binomial == 'Rhizoprionodon_acutis'), 'Binomial'] = "Rhizoprionodon_acutus"
PhysSpec[(PhysSpec$Binomial == 'Heptranchus_perlo'), 'Binomial'] = "Heptranchias_perlo"
PhysSpec[(PhysSpec$Binomial == 'Notorhynchus_cepedianus'), 'Binomial'] = "Notorynchus_cepedianus"
PhysSpec[(PhysSpec$Binomial == 'Carcahrhinus_tjutjot'), 'Binomial'] = "Carcharhinus_tjutjot"
PhysSpec[(PhysSpec$Binomial == 'Paragaleus_randelli'), 'Binomial'] = "Paragaleus_randalli"
PhysSpec[(PhysSpec$Binomial == 'Carcharhinus_cerdale'), 'Binomial'] = "Carcharhinus_cerdale"#drop/not in 2013

#Check label cerdale <- porosus & uyato <- missing from SotW 2013

fix_list <- PhysSpec[which(PhysSpec$Binomial %nin% GSH_df_pgls$Binomial),]

PhysSpec <- PhysSpec[which(PhysSpec$Binomial %nin% fix_list$Binomial),]

```



#Create species distribution for samples >1
```{r}
# count samples per species
PhysSpec_count <- PhysSpec %>% 
  count(Binomial)
#filter count by species with more than 1 sample
PhysSpec_count <- PhysSpec_count %>% 
  filter(n > 1)
#make a multiple sample list
PhysSpec_mutli <- subset(PhysSpec, PhysSpec$Binomial %in% PhysSpec_count$Binomial)
#make a single sample list
PhysSpec_singles <- subset(PhysSpec, PhysSpec$Binomial %nin% PhysSpec_count$Binomial)
# bootstrapping 
# function to bootstrap (simulate) mean gill slit height proportions for each species

bs_func <- function(x){
  # new dataframe for each species
    newdat <- PhysSpec_mutli %>% filter(., Binomial == x)
  
  # set seed so repeatable
    set.seed(8) # go giants!
  
  # create a new dataframe with the Species' name and simulated GSH proportion data
  
    # generate new GSH proportion values drawn from a normal distribution with a mean and sd of each species GSH proportions
    y <- rnorm(100, mean(newdat$MeanGSHPropTL), sd(newdat$MeanGSHPropTL))

    # generate column of species name
    x <- rep(x, 100)
    
    #Generate new CFAR proportion values based on normal distribution of samples
    tmp <- replace(newdat, is.na(newdat), 0) #doesn't this drag down the mean?
    z <- rnorm(100, mean(tmp$CFAR), sd(tmp$CFAR))
    
    # merge
    df <- data.frame(x,y,z)

}

# generate a vector of species names to apply the function to
sp_list <- unique(PhysSpec_mutli$Binomial)

# apply the function and create a new list of the output
bs_values <- lapply(sp_list, bs_func)

# turn the list into a dataframe
bs_val <- bind_rows(bs_values) %>%
          rename(Binomial = x,
                 MeanGSHPropTL = y,
                 CFAR = z)
#remove**
#bs_val_CI <- bs_val %>%
 #            group_by(Binomial) %>%
  #           dplyr::summarise(., quantile(MeanGSHPropTL, probs = c(0.025, 0.5, 0.975), na.rm = T),
   #                           ., quantile(CFAR, probs = c(0.025, 0.5, 0.975), na.rm = T))


GSH_quantile_func <- function(x){
  # new dataframe for each species
    newdat <- bs_val %>% filter(., Binomial == x)
    
    CI_GSH <- quantile(newdat$MeanGSHPropTL, probs = c(0.025,0.5, 0.975), na.rm = T)

    CI_GSH
}
 
CFAR_quantile_func <- function(x){
  newdat <- bs_val %>% filter(., Binomial == x)
  
  CI_CFAR <- quantile(newdat$CFAR, probs = c(0.025, 0.5, 0.975), na.rm=T)
  
  CI_CFAR
}
  
GSH_CI_species <- sapply(sp_list, GSH_quantile_func)

CFAR_CI_species <- sapply(sp_list, CFAR_quantile_func)


gather.matrix <- function(mat) {
  if (is.null(dimnames(mat))) {
    grid <- expand.grid(seq.int(nrow(mat)), seq.int(ncol(mat)))
  } else {
    grid <- expand.grid(dimnames(mat))
  }
  cbind(grid, value = as.vector(mat))
}

GSH_CI_species <- gather.matrix(GSH_CI_species)

CFAR_CI_species <- gather.matrix(CFAR_CI_species)

CI_species <- left_join(GSH_CI_species, CFAR_CI_species, by = c("Var2", "Var1"))

CI_species <- CI_species %>% mutate(value.y = if_else(value.y < 0, 0, value.y))

write.csv(CI_species, file = here("./Data/Output/CalAcad_Physical_CIs.csv"))
```

#Create average CI from above
```{r}
CI_species <- CI_species %>% 
  group_by(Var2) %>% 
  mutate(GSH_CI_range = max(value.x) - min(value.x),
         CFAR_CI_range = max(value.y) - min(value.y))

GSH_CI_max <- max(CI_species$GSH_CI_range)
GSH_CI_min <- min(CI_species$GSH_CI_range)
GSH_CI_average <- mean(CI_species$GSH_CI_range)

CFAR_CI_max <- max(CI_species$CFAR_CI_range, na.rm = T)
CFAR_CI_min <- min(CI_species$CFAR_CI_range, na.rm = T)
CFAR_CI_average <- mean(CI_species$CFAR_CI_range, na.rm = T)

```

#Create single specimen species with average CI
```{r}
PhysSpec_singles <- PhysSpec_singles %>% 
  rowwise() %>% 
  mutate(MeanGSHPropTL_upperCI = MeanGSHPropTL + (0.5*GSH_CI_average),
         MeanGSHPropTL_lowerCI = MeanGSHPropTL - (0.5*GSH_CI_average),
         MeanGSHPropTL_maxCI = MeanGSHPropTL + GSH_CI_average,
         MeanGSHPropTL_minCI = MeanGSHPropTL - GSH_CI_average,
         CFAR_upperCI = CFAR + (0.5*CFAR_CI_average),
         CFAR_lowerCI = CFAR - (0.5*CFAR_CI_average),
         CFAR_maxCI = CFAR + CFAR_CI_average,
         CFAR_minCI = CFAR - CFAR_CI_average)

#make negative values 0
PhysSpec_singles <- PhysSpec_singles %>% mutate(CFAR_lowerCI = if_else(CFAR_lowerCI < 0, 0, CFAR_lowerCI),
                                                CFAR_minCI = if_else(CFAR_minCI <0, 0, CFAR_minCI))


```

#Get list of species from field guide that match physical specimens
```{r}

SotW <- GSH_df_pgls %>% 
  filter(Binomial %in% PhysSpec$Binomial) 

```
#Left join SotW data to physical specimens
```{r}
#left join for multiples with CI
colnames(CI_species) <- c('Var1','Binomial','value.x','value.y','GSH_CI_range', 'CFAR_CI_range')

SotW_multi <- SotW %>% 
  filter(Binomial %in% CI_species$Binomial) %>% 
  select(Binomial, MeanGSH, CaudalAspect_proportion_TL)

PhysSpec_mutli <- left_join(CI_species, SotW_multi, by = "Binomial" )
#left join for singles
SotW_singles <- SotW %>% 
  filter(Binomial %in% PhysSpec_singles$Binomial) %>% 
  select(Binomial, MeanGSH, CaudalAspect_proportion_TL)

PhysSpec_singles <- left_join(PhysSpec_singles, SotW_singles, by = "Binomial")

```


# PCA bit 
## PCA 0 - CFAR diagram
```{r}
library(grid)
library(png)

x <- c(0:5)
y <- c(0:5)

CFAR.df <- data.frame(x,y)

CFAR.df

img1 <- readPNG(here("Data","Input","Mako-281 (1).png"))
g1 <- rasterGrob(img1, interpolate = TRUE)


cfar.plot <- ggplot(data = CFAR.df, aes(x = x, y = y)) +
  geom_segment(x = 0.1, xend = 4.9, y = 0.1, yend = 0.1, size = 2) +
  geom_segment(x = 0.1, xend = 0.1, y = 0.1, yend = 4.9, size = 2) +
  geom_segment(x = 4.9, xend = 4.9, y = 0.1, yend = 4.9, size = 2) +
  geom_segment(x = 0.1, xend = 4.9, y = 4.9, yend = 4.9, size = 2) +
  xlim(0,5) +
  ylim(0,5) +
  annotation_custom(g1, xmin = -1, ymin = 0, xmax = 4, ymax = 5) +
  annotate('text', x = 4.5, y = 2.5, label = 'h', size = 10, fontface = "italic", family = "serif") +
  annotate('text', x = 1.2, y = 2.5, label = 's', size = 10, fontface = "italic", family = "serif", color = 'white') +
  annotate('text', x = 3, y = 1,  size = 8, fontface = "italic", family = "serif", parse = TRUE, label = "A==frac(italic(h^{2}), italic(s))") +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank())

cfar.plot

ggsave(here("Data","Output","cfar.plot.png"), cfar.plot, height = 10, width = 10, units = 'cm')

```

## PCA 1 - CFAR Traits
```{r}
library(ggfortify)

GSH_PCA <- GSH_df_full

GSH_PCA <- GSH_PCA %>% 
  drop_na(LogDepthMedian)

corr_mat <- as.matrix(round(cor(GSH_PCA[,c(18,19,27)]),2))

corr_mat[upper.tri(corr_mat)] <- NA

corr_mat

pca_vals <- prcomp(GSH_PCA[,c(18,19,27)], center = T, scale = T)

summary(pca_vals)

pca_points <- as_tibble(pca_vals$x) %>% bind_cols(GSH_PCA)

pca_plot <- ggplot(pca_points, aes(x = PC1, y = PC2)) +
  geom_jitter(aes(colour = LogDepthMedian_centered), width = 0.15, height = 0.15)+
  scale_x_reverse() +
  scale_color_gradient(low = '#D1D5FF', high = '#070469', name = "Median Depth (m)", breaks = c(-2, -1, 0, 1, 2), labels = pca.depth.labels)+
  theme_light() +
  guides(color = guide_colourbar(reverse = TRUE))

pca_plot


chull_plot <- pca_plot

pca_load <- as_tibble(pca_vals$rotation, rownames = 'variable') %>% 
  mutate(variable = dplyr::recode(variable, 
                                  'TailHeight_proportionTL' = 'Tail height',
                                  'TailArea_proportionTL' = 'Tail area',
                                  'CaudalAspect_proportion_TL' = 'CFAR'))
head(pca_load)


pca_load_labels <- pca_load %>% 
  transmute(variable, PC1 = PC1*3, PC2 = PC2*3)
#tail height
pca_load_labels[1,3] <- pca_load_labels[1,3]
pca_load_labels[1,2] <- pca_load_labels[1,2]-1.2

#tail area
pca_load_labels[2,3] <- pca_load_labels[2,3]-.95
pca_load_labels[2,2] <- pca_load_labels[2,2]-.75


#cfar
pca_load_labels[3,3] <- pca_load_labels[3,3]-1
pca_load_labels[3,2] <- pca_load_labels[3,2]+0.6




chull_plot1 <- chull_plot +
  geom_segment(data = pca_load, 
               aes(x = 0, y = 0, 
                   xend = PC1*2.5,
                   yend = PC2*2.5),
               arrow = arrow(length = unit(1/2, 'picas'))) +
  geom_text(data = pca_load_labels,
           aes(label = variable),
           size = 3.5) +
  xlab('PC1 (77.75%)')+
  ylab('PC2 (21.94%)')+
  theme_bw() +
  theme(legend.position = 'none',
        legend.background = element_blank()) 

chull_plot1

ggsave(here('./Data/Output/PCA_plot_v3.png'), chull_plot1, height = 15, width = 25, units = 'cm')

```


## PCA 2 - EcoLife traits
```{r}
library(ggfortify)

GSH_PCA <- GSH_df_full

GSH_PCA <- GSH_PCA %>% 
  drop_na(LogDepthMedian)

corr_mat <- as.matrix(round(cor(GSH_PCA[,c(41,44:46)]),2))

corr_mat[upper.tri(corr_mat)] <- NA

corr_mat

pca_vals <- prcomp(GSH_PCA[,c(41,44:46)], center = T, scale = T)

summary(pca_vals)

GSH_PCA <- GSH_PCA %>% 
  mutate(LogDepthMedian_centered2 = as.factor(round(LogDepthMedian_centered)),
         LogMaxSize_centered2 = as.factor(round(LogMaxSize_centered)))


pca_points <- as_tibble(pca_vals$x) %>% bind_cols(GSH_PCA)

###labels for depths -2:2
pca.depth.labels <- rep(NA,5)


for(i in -2:2){
  pca.depth.labels[i +3] <- exp((sd(GSH_PCA$LogDepthMedian, na.rm = T)*i) + mean(GSH_PCA$LogDepthMedian, na.rm = T))
}


pca.depth.labels <- round(pca.depth.labels)

pca.label.x <- c(0.5, 1.5, 2.95, 3.5, 2)
pca.label.y <- c(-2.75, -1.75, -1.1, -0.6, 1.35)

pca.depth.labels.df <- data.frame(pca.depth.labels, pca.label.x, pca.label.y)




pca_plot <- ggplot(pca_points, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = LogDepthMedian_centered)) +
  scale_y_reverse() +
  scale_x_reverse() +
  scale_color_gradient(low = '#D1D5FF', high = '#070469', name = "Median Depth (m)", breaks = c(-2, -1, 0, 1, 2), labels = pca.depth.labels)+
  theme_light() +
  guides(color = guide_colourbar(reverse = TRUE))

#pca_hull <- pca_points %>% 
#  group_by(LogDepthMedian_centered2) %>% 
#  slice(chull(PC1, PC2))
#
#chull_plot <- pca_plot +
#  geom_polygon(data = pca_hull, aes(color = LogDepthMedian_centered2, 
#                                    fill = LogDepthMedian_centered2),
#               alpha = 0.3, show.legend = F) 
#
#chull_plot

chull_plot <- pca_plot

pca_load <- as_tibble(pca_vals$rotation, rownames = 'variable') %>% 
  mutate(variable = dplyr::recode(variable, 
                                  'LogMeanGSH_centered' = 'Mean GSH',
                                  'LogDepthMedian_centered' = 'Median depth',
                                  'LogMaxSize_centered' = 'Maximum size',
                                  'LogCFAR_centered' = 'CFAR'))
head(pca_load)


pca_load_labels <- pca_load %>% 
  transmute(variable, PC1 = PC1*5, PC2 = PC2*5)
#gsh
pca_load_labels[1,3] <- pca_load_labels[1,3]-0.1
pca_load_labels[1,2] <- pca_load_labels[1,2]-1

#depth
pca_load_labels[2,3] <- pca_load_labels[2,3]-.95
pca_load_labels[2,2] <- pca_load_labels[2,2]-.75

#size
pca_load_labels[3,3] <- pca_load_labels[3,3]+0.1
pca_load_labels[3,2] <- pca_load_labels[3,2]-1

#cfar
pca_load_labels[4,3] <- pca_load_labels[4,3]-1
pca_load_labels[4,2] <- pca_load_labels[4,2]+0.6




chull_plot2 <- chull_plot +
  geom_segment(data = pca_load, 
               aes(x = 0, y = 0, 
                   xend = PC1*2.5,
                   yend = PC2*2.5),
               arrow = arrow(length = unit(1/2, 'picas'))) +
  geom_text(data = pca_load_labels,
           aes(label = variable),
           size = 3.5) +
  xlab('PC1 (59.91%)')+
  ylab('PC2 (18.97%)')+
  theme_bw() +
  theme(legend.position = 'none',
        legend.background = element_blank()) 

chull_plot2









chull_plot2.1 <- chull_plot2 +
  geom_text(data = pca.depth.labels.df, aes(x = pca.label.x, y = pca.label.y, label = pca.depth.labels)) +
  theme(legend.position = "none")

chull_plot2.1

ggsave(here('./Data/Output/PCA_plot_v2.png'), chull_plot2.1, height = 15, width = 25, units = 'cm')


PCA_panels <- cfar.plot / chull_plot1 / chull_plot2 + plot_annotation(tag_levels = 'a')

PCA_panels


ggsave(here('./Data/Output/PCA_plot_v4.png'), PCA_panels, height = 30, width = 10, units = 'cm')


PCA_panels2 <- cfar.plot + chull_plot1 + chull_plot2 + plot_annotation(tag_levels = 'a')

PCA_panels2


ggsave(here('./Data/Output/PCA_plot_v5.png'), PCA_panels2, height = 10, width = 30, units = 'cm')



```


```{r}
### break for next plot


pca_plot <- ggplot(pca_points, aes(x = PC1, y = PC2)) +
  geom_point(aes(colour = Log10MaxSize_centered2)) +
  #scale_color_manual(values = c("Coastal" = "#d95f02",
   #                             "Deepwater" = "#7570b3",
    #                            "Pelagic" = "#1b9e77")) +
  theme_light()

pca_hull2 <- pca_points %>% 
  group_by(Log10MaxSize_centered2) %>% 
  slice(chull(PC1, PC2))

chull_plot3 <- pca_plot +
  geom_polygon(data = pca_hull2, aes(color = Log10MaxSize_centered2, 
                                    fill = Log10MaxSize_centered2),
               alpha = 0.3, show.legend = F) 

chull_plot3

pca_load2 <- as_tibble(pca_vals$rotation, rownames = 'variable') %>% 
  mutate(variable = dplyr::recode(variable, 
                                  'Log10MeanGSH_centered' = 'Mean GSH',
                                  'Log10DepthMedian_centered' = 'Depth',
                                  'Log10MaxSize_centered' = 'Max Size',
                                  'Log10CFAR_centered' = 'CFAR'))
head(pca_load2)


pca_load_labels <- pca_load2 %>% 
  transmute(variable, PC1 = PC1*5, PC2 = PC2*5)
#gsh
pca_load_labels[1,3] <- pca_load_labels[1,3]-0.1
pca_load_labels[1,2] <- pca_load_labels[1,2]+0.5

#depth
pca_load_labels[2,3] <- pca_load_labels[2,3]-.95
pca_load_labels[2,2] <- pca_load_labels[2,2]-.75

#size
pca_load_labels[3,3] <- pca_load_labels[3,3]+0.1
pca_load_labels[3,2] <- pca_load_labels[3,2]+0.5

#cfar
pca_load_labels[4,3] <- pca_load_labels[4,3]-1
pca_load_labels[4,2] <- pca_load_labels[4,2]+0.6




chull_plot4 <- chull_plot +
  geom_segment(data = pca_load, 
               aes(x = 0, y = 0, 
                   xend = PC1*2.5,
                   yend = PC2*2.5),
               arrow = arrow(length = unit(1/2, 'picas'))) +
  geom_text(data = pca_load_labels,
           aes(label = variable),
           size = 3.5) +
  xlab('PC1 (60.91%)')+
  ylab('PC2 (18.11%)')+
  theme_bw() +
  theme(legend.position = c(0.15,0.15),
        legend.background = element_blank()) 

chull_plot4


ggsave(here('./Data/Output/PCA_plot_v3.png'), chull_plot4, height = 15, width = 25, units = 'cm')

```

