---
title: "01c_STAN"
author: "Wade VanderWright"
date: '2022-03-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

###01_a -- PGLS Models for Ch. 1
## VanderWright, WJ
## March 24, 2022

## Model 1 - CFAR ~ GSH
```{r}
##Data prep #add in priors from brms?

y <- GSH_df_pgls$Log10CFAR
x <- c(GSH_df_pgls$Log10MeanGSH_centered)
N <- length(GSH_df_pgls$Binomial)

stan_data <- list(N = N, x = x, y = y)
  
fit1 <- stan(file = './StanModel1.stan', data = stan_data, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1)
  

```


```{r}
save(fit1, file = here("./Data/Output/STANMod1_v1.rds"))

posterior <- as.data.frame(fit1)
fit1_summary <- summary(fit1, pars = c('alpha','beta','sigma'), probs = c(0.025,0.975))$summary
fit1_summary
```
## Model 2 - CFAR ~ GSH * Max Size
```{r}
## Stan Model 2 -- Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered

#data matrix
data_matrix_2 <- model.matrix(~ Log10MeanGSH_centered * Log10MaxSize_centered, data = GSH_df_pgls)

#data
N <- length(GSH_df_pgls$Binomial)
y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_2
K <- ncol(x)

stan_data2 <- list(N=N,K=K,y=y,x=x)


fit2 <- stan(file = './StanModel2.stan', data = stan_data2, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1)
  
save(fit2, file = here('./Data/Output/STANMod2_v1.rds'))
```

```{r}

posterior2 <- as.data.frame(fit2)
fit2_summary <- summary(fit2, pars = c('beta[1]','beta[2]','beta[3]','beta[4]','sigma'), probs = c(0.025,0.975))$summary
dimnames(fit2_summary)[[1]] <- c('alpha','beta','beta2 (size)','GSH:Size','sigma')
fit2_summary

```


## Model 3 - CFAR ~ GSH + Max Size (No interaction)
```{r}
## Stan Model 3 -- Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered

#data matrix
data_matrix_3 <- model.matrix(~ Log10MeanGSH_centered + Log10MaxSize_centered, data = GSH_df_pgls)

#data
N <- length(GSH_df_pgls$Binomial)
y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_3
K <- ncol(x)

stan_data3 <- list(N=N,K=K,y=y,x=x)


fit3 <- stan(file = './StanModel2.stan', data = stan_data3, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1)
  
save(fit3, file = here('./Data/Output/STANMod3_v1.rds'))
```


```{r}
posterior3 <- as.data.frame(fit3)
fit3_summary <- summary(fit3, pars = c("beta[1]", "beta[2]",'beta[3]',"sigma"), probs = c(0.025, 0.975))$summary
dimnames(fit3_summary)[[1]] <- c('alpha','beta','beta2 (size)','sigma')
fit3_summary
```

## Model 4 - CFAR ~ GSH + PrimaryHabitat (No interaction)
```{r}
## Stan Model 6 -- Log10CFAR ~ Log10MeanGSH_centered + PrimaryHabitat
data_matrix_4 <- model.matrix(~ Log10MeanGSH_centered + PrimaryHabitat, data = GSH_df_pgls)


#data
N <- length(GSH_df_pgls$Binomial)
y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_4
K <- ncol(x)

stan_data4 <- list(N=N,K=K,y=y,x=x)


fit4 <- stan(file = './StanModel2.stan', data = stan_data4, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1)
  
save(fit4, file = here('./Data/Output/STANMod4_v1.rds'))
```


```{r}
posterior4 <- as.data.frame(fit4)
fit4_summary <- summary(fit4, pars = c('beta[1]','beta[2]','beta[3]','beta[4]','sigma'), probs = c(0.025,0.975))$summary
dimnames(fit4_summary)[[1]] <- c('alpha','beta','deepwater','pelagic','sigma')
fit4_summary
```
## Model 5 - CFAR ~ GSH * PrimaryHabitat
```{r}
## Stan Model 6 -- Log10CFAR ~ Log10MeanGSH_centered * PrimaryHabitat
data_matrix_5 <- model.matrix(~ Log10MeanGSH_centered * PrimaryHabitat, data = GSH_df_pgls)


#data
N <- length(GSH_df_pgls$Binomial)
y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_5
K <- ncol(x)
stan_data5 <- list(N=N,K=K,y=y,x=x)


fit5 <- stan(file = './StanModel2.stan', data = stan_data5, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1)
  
save(fit5, file = here('./Data/Output/STANMod5_v1.rds'))
```


```{r}
posterior5 <- as.data.frame(fit5)

fit5_summary <- summary(fit5, pars = c('beta[1]','beta[2]','beta[3]','beta[4]','beta[5]','beta[6]','sigma'), probs = c(0.025,0.975))$summary
dimnames(fit5_summary)[[1]] <- c('alpha','beta','deepwater','pelagic','GSH:deepwater','GSH:pelagic','sigma')
fit5_summary
```

## Model 6 - CFAR ~ GSH + Phylogeny
```{r}

data_matrix_6 <- model.matrix(~ Log10MeanGSH_centered, data = GSH_df_pgls)

#Stan Code
stancode = "data {
  int <lower=0> N; // number of data points
  int <lower=0> K; // number of predictors 
  matrix[N,K] x; // predictor matrix
  vector[N] y; // outcome (CFAR)
  matrix[N, N] d_mat; // sigma matrix
  matrix[N, N] A; // vcov matrix
      }

// The parameters accepted by the model. 

      parameters {
        vector[K] beta; // coefficients
        real<lower=0> sigma; // error
        real<lower=0,upper=1> lambda; // phylogenetic signal
      }
      
      
      transformed parameters {
        
        matrix[N, N] sigma_mat;
        matrix[N, N] sigma_total;
        
        

        sigma_mat = (1-lambda)*d_mat + lambda*A;
        sigma_total = sigma*sigma_mat;
        
        

      }

// The model to be estimated. We model the output
// 'y' to be normally distributed with mean 'mu'
// and standard deviation 'sigma'.
model {
  
  beta ~ student_t(3, 0, 10);
  lambda ~ uniform(0,1);
  sigma ~ student_t(3, 0, 2.5);
  
  y ~ multi_normal(x * beta, sigma_total);
}

// need to redefine to keep for comaprison
generated quantities {
 
        real log_lik;
        
        log_lik = multi_normal_lpdf(y | x * beta, sigma_total);
      
}"

writeLines(stancode,'./StanModelCode.stan')



y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_6
N <- length(GSH_df_pgls$Binomial)
K <- ncol(x)
d_mat <- diag(1, 456, 456)



stan_data6 <- list(N = N, x = x, y = y, K = K, d_mat = d_mat, A = A)

compile <- stan_model(file = './StanModel3.stan')

fit6 <- stan(file = './StanModel3.stan', data = stan_data6, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1,
             pars = c('beta','sigma','lambda', 'log_lik', 'sigma_total'))
  
save(fit6, file = here("./Data/Output/STANMod6_v1.rds"))
```

```{r}


posterior6 <- extract(fit6)

fit6_summary <- summary(fit6, pars = c('beta[1]','beta[2]','sigma','lambda'), probs = c(0.025,0.975))$summary
dimnames(fit6_summary)[[1]] <- c('alpha','beta','sigma','lambda')
fit6_summary
```
## Model 7 - CFAR ~ GSH * Max Size + Phylogeny
```{r}

data_matrix_7 <- model.matrix(~ Log10MeanGSH_centered * Log10MaxSize_centered, data = GSH_df_pgls)

y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_7
N <- length(GSH_df_pgls$Binomial)
K <- ncol(x)
d_mat <- diag(1, 456, 456)



stan_data7 <- list(N = N, x = x, y = y, K =K, d_mat = d_mat, A = A)
  

fit7 <- stan(file = './StanModel3.stan', data = stan_data7, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1,
             pars = c('beta','sigma','lambda', 'log_lik', 'sigma_total'))

save(fit7, file = here("./Data/Output/STANMod7_v1.rds"))
```

```{r}


posterior7 <- as.data.frame(fit7)

fit7_summary <- summary(fit7, pars = c('beta[1]','beta[2]','beta[3]','beta[4]','sigma','lambda'), probs = c(0.025,0.975))$summary
dimnames(fit7_summary)[[1]] <- c('alpha','beta','beta2 (size)','GSH:MaxSize','sigma','lambda')
fit7_summary
```

## Model 8 - CFAR ~ GSH + Max Size + Phylogeny
```{r}
data_matrix_8 <- model.matrix(~ Log10MeanGSH_centered + Log10MaxSize_centered, data = GSH_df_pgls)

y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_8
N <- length(GSH_df_pgls$Binomial)
K <- ncol(x)
d_mat <- diag(1, 456, 456)

stan_data8 <- list(N = N, x = x, y = y, K =K, d_mat = d_mat, A = A)

fit8 <- stan(file = './StanModel3.stan', data = stan_data8, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1,
             pars = c('beta','sigma','lambda', 'log_lik', 'sigma_total'))

save(fit8, file = here("./Data/Output/STANMod8_v1.rds"))

```

```{r}

posterior8 <- as.data.frame(fit8)

fit8_summary <- summary(fit8, pars = c('beta[1]','beta[2]','beta[3]','sigma','lambda'), probs = c(0.025,0.975))$summary
dimnames(fit8_summary)[[1]] <- c('alpha','beta','beta2 (size)','sigma','lambda')
fit8_summary
```

## Model 9 - CFAR ~ GSH + PrimaryHabitat + Phylogeny
```{r}
data_matrix_9 <- model.matrix(~ Log10MeanGSH_centered + PrimaryHabitat, data = GSH_df_pgls)

y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_9
N <- length(GSH_df_pgls$Binomial)
K <- ncol(x)
d_mat <- diag(1, 456, 456)

stan_data9 <- list(N = N, x = x, y = y, K =K, d_mat = d_mat, A = A)

fit9 <- stan(file = './StanModel3.stan', data = stan_data9, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1,
             pars = c('beta','sigma','lambda', 'log_lik', 'sigma_total'))

save(fit9, file = here("./Data/Output/STANMod9_v1.rds"))

```

```{r}

posterior9 <- as.data.frame(fit9)

fit9_summary <- summary(fit9, pars = c('beta[1]','beta[2]','beta[3]','beta[4]','sigma','lambda'), probs = c(0.025,0.975))$summary
dimnames(fit9_summary)[[1]] <- c('alpha','beta','deepwater','pelagic','sigma','lambda')
fit9_summary
```

## Model 10 - CFAR ~ GSH * PrimaryHabitat + Phylogeny
```{r}
data_matrix_10 <- model.matrix(~ Log10MeanGSH_centered * PrimaryHabitat, data = GSH_df_pgls)

y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_10
N <- length(GSH_df_pgls$Binomial)
K <- ncol(x)
d_mat <- diag(1, 456, 456)

stan_data10 <- list(N = N, x = x, y = y, K =K, d_mat = d_mat, A = A)

fit10 <- stan(file = './StanModel3.stan', data = stan_data10, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1,
             pars = c('beta','sigma','lambda', 'log_lik', 'sigma_total'))

save(fit10, file = here("./Data/Output/STANMod10_v1.rds"))

```

```{r}

posterior10 <- as.data.frame(fit10)

fit10_summary <- summary(fit10, pars = c('beta[1]','beta[2]','beta[3]','beta[4]','beta[5]','beta[6]','sigma','lambda'), probs = c(0.025,0.975))$summary
dimnames(fit10_summary)[[1]] <- c('alpha','beta','deepwater','pelagic','GSH:deepwater','GSH:pelagic','sigma','lambda')
fit10_summary
```

## Model 11 - CFAR ~ GSH * MaxSize + PrimaryHabitat + Phylogeny

```{r}
data_matrix_11 <- model.matrix(~ Log10MeanGSH_centered * Log10MaxSize_centered + PrimaryHabitat, data = GSH_df_pgls)

y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_11
N <- length(GSH_df_pgls$Binomial)
K <- ncol(x)
d_mat <- diag(1, 456, 456)

stan_data11 <- list(N = N, x = x, y = y, K =K, d_mat = d_mat, A = A)

fit11 <- stan(file = './StanModel3.stan', data = stan_data11, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1,
             pars = c('beta','sigma','lambda', 'log_lik'))

save(fit11, file = here("./Data/Output/STANMod11_v1.rds"))

```


```{r}

posterior11 <- as.data.frame(fit11)

fit11_summary <- summary(fit11, pars = c('beta[1]','beta[2]','beta[3]','beta[4]','beta[5]','beta[6]','sigma','lambda'), probs = c(0.025,0.975))$summary
dimnames(fit11_summary)[[1]] <- c('alpha','beta','beta2 (size)','deepwater','pelagic','GSH:MaxSize','sigma','lambda')
fit11_summary
```


## Model 12 - CFAR ~ GSH * MaxSize * PrimaryHabitat + Phylogeny

```{r}
data_matrix_12 <- model.matrix(~ Log10MeanGSH_centered * Log10MaxSize_centered * PrimaryHabitat, data = GSH_df_pgls)

y <- GSH_df_pgls$Log10CFAR
x <- data_matrix_12
N <- length(GSH_df_pgls$Binomial)
K <- ncol(x)
d_mat <- diag(1, 456, 456)

stan_data12 <- list(y = y, x = x, N = N, K = K, d_mat = d_mat, A = A)

fit12 <- stan(file = './StanModel3.stan', data = stan_data12, warmup = 1000, iter = 5000, chains = 4, cores = 4, thin = 1, 
              pars = c('beta', 'sigma', 'lambda', 'log_lik', 'sigma_total'))

save(fit12, file = here('./Data/Output/STANMod12_v1.rds'))
```

```{r}
posterior12 <- as.data.frame(fit12)

fit12_summary <- summary(fit12, pars = c('beta[1]','beta[2]','beta[3]','beta[4]','beta[5]','beta[6]','sigma','lambda'), probs = c(0.025,0.975))$summary
dimnames(fit10_summary)[[1]] <- c('alpha','beta','deepwater','pelagic','GSH:deepwater','GSH:pelagic','sigma','lambda')
fit12_summary
```


##LOO comapre (quick and dirty version)

```{r}
fit1_loo <- loo(fit1)
fit2_loo <- loo(fit2)
fit3_loo <- loo(fit3)
fit4_loo <- loo(fit4)
fit5_loo <- loo(fit5)

loo_compare(fit1_loo, fit2_loo, fit3_loo, fit4_loo, fit5_loo)



fit6_loo <- loo(fit6)
fit7_loo <- loo(fit7)
fit8_loo <- loo(fit8)
fit9_loo <- loo(fit9)
fit10_loo <- loo(fit10)
fit11_loo <- loo(fit11)

loo1 <- add_criterion(fit6, "loo")
loo2 <- add_criterion(mean_no_phylo_brms_int, "loo")

loo_list <- list(loo1, loo2)
loo_model_weights(loo_list)
loo_compare(loo_list)


loo_compare(fit6_loo, fit7_loo)

```




