---
title: "Ch. 1 - Model comaprisons"
author: "Wade VanderWright"
date: '2022-02-25'
output: 
  pdf_document:
    fig_height: 5
    fig_width: 7
    df_print: kable
    toc: TRUE
  

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(knitr.table.format = 'latex')


Table_fun <- function(x){

table <- cbind(summary(x)$tTable, confint(x))

kbl(table, caption = "PGLS summary") %>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))

}




Plot_brms <- function(x, y =NULL){
  plot(GSH_df_pgls$Log10CFAR ~ GSH_df_pgls$Log10MeanGSH_centered, pch = 20,
       main = paste("Correlation=", cor(GSH_df_pgls$Log10CFAR, GSH_df_pgls$Log10MeanGSH_centered)),
       xlab = "Log10 GSH (proportion of TL)",
       ylab = "Log10 CFAR")

abline(a = coef(y)[1], b = coef(y)[2], col = 6, lw = 2)

  
for (i in 1:500) {
 abline(fixef(x, summary = F)[i,1], fixef(x, summary = F)[i,2], col = adjustcolor("gray", alpha = 0.05), lty = 1)
}

 abline(fixef(x)[1,1], fixef(x)[2,1], col = 'blue', lw = 2)
  
}

Plot_stan <- function(x,y,z=NULL){
    plot(GSH_df_pgls$Log10CFAR ~ GSH_df_pgls$Log10MeanGSH_centered, pch = 20,
       main = paste("Correlation=", cor(GSH_df_pgls$Log10CFAR, GSH_df_pgls$Log10MeanGSH_centered)),
       xlab = "Log10 GSH (proportion of TL)",
       ylab = "Log10 CFAR")
  
abline(a = coef(z)[1], b = coef(z)[2], col = 6, lw = 2)
  
  
  for (i in 1:200) {
 abline(x[i,1], x[i,2], col = adjustcolor("gray", alpha = 0.05), lty = 1)
}

abline(fixef(y)[1,1], fixef(y)[2,1], col = 'blue', lw = 2)

abline(mean(x[,1]), mean(x[,2]), col = 'red', lw = 2)
}

Plot_pgls <- function(x){
   plot(GSH_df_pgls$Log10CFAR ~ GSH_df_pgls$Log10MeanGSH_centered, pch = 20,
       main = paste("Correlation=", cor(GSH_df_pgls$Log10CFAR, GSH_df_pgls$Log10MeanGSH_centered)),
       xlab = "Log10 GSH (proportion of TL)",
       ylab = "Log10 CFAR")
  
  abline(a = coef(x)[1], b = coef(x)[2], col = 6, lw = 2)
}

##Load Packages
library(ape)
library(phytools)
library(nlme)
library(tidyr)
library(tibble)
library(kableExtra)
library(ggplot2)
library(dplyr)
library(geiger)
#library(caper)
#library(xlsx)
library(here)
library(readxl)
library(StanHeaders)
library(brms)
#library(kable)
library(rstan)
library(gdata)
library(bayesplot)

#Run this and skip to line 348
load(here('./Data/Output/CurrentDataState.RData'))

```
\newpage
# Hypothesis summaries
## No Phylogeny
```{r echo=FALSE}
Model1 <- 'Log10CFAR ~ Log10GSH'
Model2 <- 'Log10CFAR ~ Log10GSH * MaxSize'
Model3 <- 'Log10CFAR ~ Log10GSH + MaxSize'
Model4 <- 'Log10CFAR ~ Log10GSH + PrimaryHabitat'
Model5 <- 'Log10CFAR ~ Log10GSH * PrimaryHabitat'

modellist1 <- c(Model1, Model2, Model3, Model4, Model5)

Model1_hyp <- 'Activity only varies with gill slit height'
Model2_hyp <- 'Activity varies with gill slit height and maximum size and the effect of gill slit height varies with maximum size'
Model3_hyp <- 'Activity varies with gill slit height and maximum size'
Model4_hyp <- 'Activity varies with gill slit height and primary habitat'
Model5_hyp <- 'Activity varies with gill slit height and primary habitat and the effect of gill slit height varies with primary habitat'

modelhyplist1 <- c(Model1_hyp, Model2_hyp, Model3_hyp, Model4_hyp, Model5_hyp)

Table1.1 <- data.frame(modellist1, modelhyplist1)

kbl(Table1.1, col.names = c('Model','Hypothesis'), booktabs = T, linesep = "") %>% 
  kable_styling(latex_options = c("striped","scale_down","hold_position"), full_width = T)

```

## With Phylogeny
```{r echo=FALSE}
Model6 <- 'Log10CFAR ~ Log10GSH + Phylogeny'
Model7 <- 'Log10CFAR ~ Log10GSH * MaxSize + Phylogeny'
Model8 <- 'Log10CFAR ~ Log10GSH + MaxSize + Phylogeny'
Model9 <- 'Log10CFAR ~ Log10GSH + PrimaryHabitat + Phylogeny'
Model10 <- 'Log10CFAR ~ Log10GSH * PrimaryHabitat + Phylogeny'
Model11 <- 'Log10CFAR ~ Log10GSH * MaxSize + PrimaryHabitat + Phylogeny'

modellist2 <- c(Model6, Model7, Model8, Model9, Model10, Model11)

Model6_hyp <- 'Activity only varies with gill slit height and is conserved across evolutionary history'
Model7_hyp <- 'Activity varies with gill slit height and maximum size and the effect of gill slit height varies with maximum size and is conserved across evolutionary history'
Model8_hyp <- 'Activity varies with gill slit height and maximum size and is conserved across evolutionary history'
Model9_hyp <- 'Activity varies with gill slit height and primary habitat and is conserved across evolutionary history'
Model10_hyp <- 'Activity varies with gill slit height and primary habitat and the effect of gill slit height varies with primary habitat and is conserved across evolutionary history'
Model11_hyp <- 'Activity varies with gill slit height, maximum size, and primary habitat, and the effect of gill slit height varies with maximum size and is conserved across evolutionary history'

modelhyplist2 <- c(Model6_hyp, Model7_hyp, Model8_hyp, Model9_hyp, Model10_hyp,
                   Model11_hyp)

Table1.2 <- data.frame(modellist2, modelhyplist2)

write.csv(Table1.2, file = here("./Data/Output/ModelDescriptions.csv"))

kbl(Table1.2, col.names = c('Model','Hypothesis'), booktabs = T, linesep = "") %>% 
  kable_styling(latex_options = c("striped", "scale_down", "hold_position"), full_width = T)
```
\newpage
# Model Comparisons
## No Phylogeny
### Model 1 - CFAR ~ GSH

1. brms model
```
brms_1 <- brm(Log10CFAR ~ Log10MeanGSH_centered,
                    data = GSH_df_pgls,
                    family = gaussian(),
                    prior = Plain_prior,
                    warmup = 1000, iter = 5000,
                    cores = 4
                    )
```

```{r echo=FALSE}
kbl(fixef(brms_1, summary = T), booktabs = T, linesep = "", caption = 'brms model summary') %>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))

```


```{r echo=FALSE}
Plot_brms(Model_plain)

```


2. STAN model

Data considered
```
data {
  int <lower=1> N;
  vector[N] x;
  vector[N] y;
}
```
The parameters accepted by the model
```
parameters {
  real alpha;
  real beta;
  real<lower=0> sigma;
}
```
Model form:
```
model {
  
  sigma ~ student_t(3, 0, 10);
  
  y ~ normal(alpha + x * beta , sigma);
}
```


```{r echo=FALSE}
knitr::kable(fit1_summary, caption = 'STAN model summary', booktabs = T, linesep = "")%>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))
```

```{r echo=FALSE}
Plot_stan(posterior, Model_plain)
```
\newpage

### Model 2 - CFAR ~ GSH * Max Size

1. brms model
```
Model_size <- brm(Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered,
                    data = GSH_df_pgls,
                    family = gaussian(),
                    prior = Size_prior
                    )
  ```                  
```{r echo=FALSE}
kbl(fixef(Model_size, summary = T), caption = 'brms model 2 summary', booktabs = T, linesep = "")%>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))
```

```{r echo=FALSE}
Plot_brms(Model_size)
```


2. STAN model

Data considered

```

data {
  int <lower=0> N; // number of data points
  int <lower=0> K; // number of predictors
  matrix[N,K] x; // predictor matrix
  vector[N] y; // CFAR
}
```

The parameters accepted by the model. 
```
parameters {
  real alpha;
  vector[K] beta;
  real<lower=0> sigma;
}
```

The model to be estimated. We model the output 'y' to be normally distributed with mean 'mu' and standard deviation 'sigma'.

```
model {

  sigma ~ student_t(3, 0, 10);

  y ~ normal(alpha + x * beta , sigma);
}
```



```{r echo=FALSE}
knitr::kable(fit2_summary, caption = 'STAN model summary', booktabs = T, linesep = "")%>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))
```

```{r echo=FALSE}
Plot_stan(posterior2, Model_size)

```
\newpage

### Model 3 - CFAR ~ GSH + Max Size (No interaction)

1. brms model

```
Model_size_2 <- brm(Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered,
                    data = GSH_df_pgls,
                    family = gaussian(),
                    prior = Size_prior_2)
```
```{r echo=FALSE}
kbl(fixef(Model_size_2, summary = T), caption = 'brms model 3 summary', booktabs = T, linesep = "")%>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))
```

```{r echo=FALSE}
Plot_brms(Model_size_2)
```

2. STAN model


Data considered

```

data {
  int <lower=0> N; // number of data points
  int <lower=0> K; // number of predictors
  matrix[N,K] x; // predictor matrix
  vector[N] y; // CFAR
}
```

The parameters accepted by the model. 

```
parameters {
  real alpha;
  vector[K] beta;
  real<lower=0> sigma;
}
```

The model to be estimated. We model the output 'y' to be normally distributed with mean 'mu' and standard deviation 'sigma'.

```
model {

  sigma ~ student_t(3, 0, 10);

  y ~ normal(alpha + x * beta , sigma);
}
```


```{r echo=FALSE}
knitr::kable(fit3_summary, caption = 'STAN model summary', booktabs = T, linesep = "")%>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))
```

```{r echo=FALSE}
Plot_stan(posterior3, Model_size_2)
```
\newpage

### Model 4 - CFAR ~ GSH + PrimaryHabitat (No interaction)

1. brms model
```
habitat_model <- brm(Log10CFAR ~ Log10MeanGSH_centered + PrimaryHabitat,
                    data = GSH_df_pgls,
                    family = gaussian(),
                    prior = habitat_prior,
                    cores = 2)
```

```{r echo = FALSE}
kbl(fixef(habitat_model, summary = T), caption = 'brms model 4 summary', booktabs = T, linesep = "")%>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))
```

```{r echo=FALSE}
Plot_brms(habitat_model)
```


2. STAN model

Data considered

```

data {
  int <lower=0> N; // number of data points
  int <lower=0> K; // number of predictors
  matrix[N,K] x; // predictor matrix
  vector[N] y; // CFAR
}
```

The parameters accepted by the model. 

```
parameters {
  real alpha;
  vector[K] beta;
  real<lower=0> sigma;
}
```

The model to be estimated. We model the output 'y' to be normally distributed with mean 'mu' and standard deviation 'sigma'.

```
model {

  sigma ~ student_t(3, 0, 10);

  y ~ normal(alpha + x * beta , sigma);
}
```


```{r echo=FALSE}
knitr::kable(fit4_summary, caption = 'STAN model summary', booktabs = T, linesep = "")%>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))
```

```{r echo=FALSE}
Plot_stan(posterior4, habitat_model)

```

\newpage

### Model 5 - CFAR ~ GSH * PrimaryHabitat
1. brms model
```
habitat_model_2 <- brm(Log10CFAR ~ Log10MeanGSH_centered * PrimaryHabitat,
                    data = GSH_df_pgls,
                    family = gaussian(),
                    prior = habitat_prior2,
                    cores = 2)
```
```{r echo = FALSE}
kbl(fixef(habitat_model_2, summary = T), caption = 'brms model 5 summary', booktabs = T, linesep = "")%>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))
```

```{r echo=FALSE}
Plot_brms(habitat_model_2)
```

2. STAN model

Data considered

```

data {
  int <lower=0> N; // number of data points
  int <lower=0> K; // number of predictors
  matrix[N,K] x; // predictor matrix
  vector[N] y; // CFAR
}
```

The parameters accepted by the model. 

```
parameters {
  real alpha;
  vector[K] beta;
  real<lower=0> sigma;
}
```

The model to be estimated. We model the output 'y' to be normally distributed with mean 'mu' and standard deviation 'sigma'.

```
model {

  sigma ~ student_t(3, 0, 10);

  y ~ normal(alpha + x * beta , sigma);
}
```



```{r echo=FALSE}
knitr::kable(fit5_summary, caption = 'STAN model summary', booktabs = T, linesep = "")%>% 
  kable_styling(full_width = T, latex_options = c('striped','hold_position','scale_down'))
```

```{r echo=FALSE}
Plot_stan(posterior5, habitat_model_2)
```

\newpage

### BRMS LOO analysis

LOO compare
```{r}
fit1_loo <- loo(Model_plain)
fit2_loo <- loo(Model_size)
fit3_loo <- loo(Model_size_2)
fit4_loo <- loo(habitat_model)
fit5_loo <- loo(habitat_model_2)

brms_loo_nonphylo_list <- list(fit1_loo, fit2_loo, fit3_loo, fit4_loo, fit5_loo)
brms_loo_nonphylo <- loo_compare(brms_loo_nonphylo_list)

kbl(brms_loo_nonphylo, booktabs = T, linesep = "") %>% 
  kable_styling(latex_options = c("scale_down","hold_postion"))

```

LOO model weights

```{r}
loo_model_weights(brms_loo_nonphylo_list)
```

\newpage

## With phylogeny

### Model 6 - CFAR ~ GSH + Phylogeny

1. PGLS model
```
pglsMod1 <- gls(Log10CFAR ~ Log10MeanGSH_centered, correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), 
                data = GSH_df_pgls, method = "ML")
```

```{r echo=FALSE}

Table_fun(pglsMod1)

```

```{r echo=FALSE}
Plot_pgls(pglsMod1)
```

2. brms model
```
Model_simple <- brm(Log10CFAR ~ Log10MeanGSH_centered + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A),
                    prior = Simple_prior,
                    cores = 2)
```
                    
```{r echo=FALSE}
kbl(fixef(Model_simple, summary = T), caption = 'brms model 6 summary', booktabs = T, linesep = "") %>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```


```{r echo=FALSE}
Plot_brms(Model_simple, pglsMod1)
```

3. STAN model


Data considered

```
data {
  int <lower=0> N; // number of data points
  int <lower=0> K; // number of predictors 
  matrix[N,K] x; // predictor matrix
  vector[N] y; // outcome (CFAR)
  matrix[N, N] d_mat; // sigma matrix
  matrix[N, N] A; // vcov matrix
      }
```

The parameters accepted by the model. 

```
 parameters {
        real alpha;
        vector[K] beta; // coefficients
        real<lower=0> sigma; // error
        real<lower=0,upper=1> lambda; // phylogenetic signal
      }
      
      
      transformed parameters {
        
        matrix[N, N] sigma_mat;
        matrix[N, N] sigma_total;
        
        vector[N] mu_y;
        

        sigma_mat = (1-lambda)*d_mat + lambda*A;
        sigma_total = sigma*sigma_mat;
        
        

      }
```

The model to be estimated. We model the output 'y' to be normally distributed with mean 'mu' and standard deviation 'sigma'.

```
model {
  
  beta ~ student_t(3, 0, 10);
  lambda ~ uniform(0,1);
  sigma ~ student_t(3, 0, 2.5);
  
  y ~ multi_normal(alpha + x * beta, sigma_total);
}
```

```{r echo=FALSE}
kbl(fit6_summary, caption = 'STAN model 6 summary', booktabs = T, linesep = "") %>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```

```{r echo=FALSE}
Plot_stan(posterior6, Model_simple, z=pglsMod1)
```

\newpage

### Model 7 - CFAR ~ GSH * Max Size + Phylogeny

1. PGLS model

```
pglsMod2 <- gls(Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered, correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), data = GSH_df_pgls, method = "ML")
```


```{r echo=FALSE}
Table_fun(pglsMod2)
```

```{r echo=FALSE}
Plot_pgls(pglsMod2)
```


2. brms model
```
Model_BS <- brm(Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A),
                    prior = BS_prior,
                sample_prior = TRUE, chains = 4, cores = 2)
```

```{r echo=FALSE}
kbl(fixef(Model_BS, summary = T), caption = 'brms model 7 summary', booktabs = T, linesep = "")%>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```

```{r echo=FALSE}
Plot_brms(Model_BS, pglsMod2)
```

3. STAN model

Data considered

```
data {
  int <lower=0> N; // number of data points
  int <lower=0> K; // number of predictors 
  matrix[N,K] x; // predictor matrix
  vector[N] y; // outcome (CFAR)
  matrix[N, N] d_mat; // sigma matrix
  matrix[N, N] A; // vcov matrix
      }
```

The parameters accepted by the model. 

```
 parameters {
        real alpha;
        vector[K] beta; // coefficients
        real<lower=0> sigma; // error
        real<lower=0,upper=1> lambda; // phylogenetic signal
      }
      
      
      transformed parameters {
        
        matrix[N, N] sigma_mat;
        matrix[N, N] sigma_total;
        
        vector[N] mu_y;
        

        sigma_mat = (1-lambda)*d_mat + lambda*A;
        sigma_total = sigma*sigma_mat;
        
        

      }
```

The model to be estimated. We model the output 'y' to be normally distributed with mean 'mu' and standard deviation 'sigma'.

```
model {
  
  beta ~ student_t(3, 0, 10);
  lambda ~ uniform(0,1);
  sigma ~ student_t(3, 0, 2.5);
  
  y ~ multi_normal(alpha + x * beta, sigma_total);
}
```

```{r echo=FALSE}
kbl(fit7_summary, caption = 'STAN model 7 summary', booktabs = T, linesep = "")%>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```

```{r echo=FALSE}
Plot_stan(posterior7, Model_BS, pglsMod2)

```

\newpage

### Model 8 - CFAR ~ GSH + Max Size + Phylogeny

1. PGLS model

```
pglsMod3 <- gls(Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered, correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), data = GSH_df_pgls, method = "ML")
```

```{r echo=FALSE}
Table_fun(pglsMod3)
```

```{r echo=FALSE}
Plot_pgls(pglsMod3)
```

2. brms model
```
Model_BS <- brm(Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A),
                    prior = BS_prior,
                sample_prior = TRUE, chains = 4, cores = 2)
```

```{r echo=FALSE}
kbl(fixef(Model_BS2, summary = T), caption = 'brms model 8 summary', booktabs = T, linesep = "")%>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```

```{r echo=FALSE}
Plot_brms(Model_BS2, pglsMod3)
```

3. STAN model


Data considered

```
data {
  int <lower=0> N; // number of data points
  int <lower=0> K; // number of predictors 
  matrix[N,K] x; // predictor matrix
  vector[N] y; // outcome (CFAR)
  matrix[N, N] d_mat; // sigma matrix
  matrix[N, N] A; // vcov matrix
      }
```

The parameters accepted by the model. 

```
 parameters {
        real alpha;
        vector[K] beta; // coefficients
        real<lower=0> sigma; // error
        real<lower=0,upper=1> lambda; // phylogenetic signal
      }
      
      
      transformed parameters {
        
        matrix[N, N] sigma_mat;
        matrix[N, N] sigma_total;
        
        vector[N] mu_y;
        

        sigma_mat = (1-lambda)*d_mat + lambda*A;
        sigma_total = sigma*sigma_mat;
        
        

      }
```

The model to be estimated. We model the output 'y' to be normally distributed with mean 'mu' and standard deviation 'sigma'.

```
model {
  
  beta ~ student_t(3, 0, 10);
  lambda ~ uniform(0,1);
  sigma ~ student_t(3, 0, 2.5);
  
  y ~ multi_normal(alpha + x * beta, sigma_total);
}
```


```{r echo=FALSE}
kbl(fit8_summary, caption = 'STAN model 8 summary', booktabs = T, linesep = "")%>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```

```{r echo=FALSE}
Plot_stan(posterior8, Model_BS2, pglsMod3)
```
\newpage

### Model 9 - CFAR ~ GSH + PrimaryHabitat + Phylogeny
1. PGLS model
```
pglsMod5 <- gls(Log10CFAR ~ Log10MeanGSH_centered + PrimaryHabitat, 
                correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial), 
                data = GSH_df_pgls, method = "ML")
```

```{r echo=FALSE}
Table_fun(pglsMod5)
```


```{r echo=FALSE}
Plot_pgls(pglsMod5)
```
2. brms model
```
HabitatPhylo <- brm(Log10CFAR ~ Log10MeanGSH_centered + Log10MaxSize_centered + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A),
                    prior = BS_prior2,
                sample_prior = TRUE, chains = 4, cores = 2)
```

```{r echo=FALSE}
kbl(fixef(HabitatPhylo, summary = T), caption = 'brms model 9 summary', booktabs = T, linesep = "")%>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```

```{r echo=FALSE}
Plot_brms(HabitatPhylo, pglsMod5 )
```

3. STAN Model

```{r echo=FALSE}
kbl(fit9_summary, caption = 'STAN model 8 summary', booktabs = T, linesep = "")%>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```

```{r echo=FALSE}
Plot_stan(posterior9, HabitatPhylo, pglsMod5)
```
\newpage

### Model 10 - CFAR ~ GSH * PrimaryHabitat + Phylogeny
1. PGLS model

```
pglsMod6 <- gls(Log10CFAR ~ Log10MeanGSH_centered * PrimaryHabitat, 
                correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial),
                data = GSH_df_pgls, method = "ML")

```

```{r echo=FALSE}
Table_fun(pglsMod6)
```

```{r echo=FALSE}
Plot_pgls(pglsMod6)
```

2. BRMS Model
```
HabitatPhylo2 <- brm(Log10CFAR ~ Log10MeanGSH_centered * PrimaryHabitat + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A),
                    prior = HabitatPhylo_prior2,
                sample_prior = TRUE, chains = 4, cores = 4)
          
```


```{r echo=FALSE}
kbl(fixef(HabitatPhylo2, summary = T), caption = 'brms model 10 summary', booktabs = T, linesep = "")%>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```

```{r echo=FALSE}
Plot_brms(HabitatPhylo2, pglsMod6)
```

3. STAN Model


```{r echo=FALSE}
kbl(fit10_summary, caption = 'STAN model 8 summary', booktabs = T, linesep = "")%>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```

```{r echo=FALSE}
Plot_stan(posterior10, HabitatPhylo2, pglsMod6)
```

\newpage
### Model 11 - CFAR ~ GSH * MaxSize + PrimaryHabitat + Phylogeny
1. PGLS model

```
pglsMod8 <- gls(Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered + PrimaryHabitat, 
                correlation = corPagel(phy = SampleTree, value = 0.5, fixed = F, form = ~Binomial),
                data = GSH_df_pgls, method = "ML")
```

```{r echo=FALSE}
Table_fun(pglsMod8)
```

```{r echo=FALSE}
Plot_pgls(pglsMod8)
```


2. BRMS Model
```
SizeHabitatModel <- brm(Log10CFAR ~ Log10MeanGSH_centered * Log10MaxSize_centered + PrimaryHabitat + (1|gr(Binomial, cov = A)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(A = A),
                    prior = SizeHabitatMod_prior,
                sample_prior = TRUE, chains = 4, cores = 4)
```

```{r echo=FALSE}
kbl(fixef(brms_11, summary = T),caption = 'brms model 11 summary', booktabs = T, linesep = "")%>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
Table11 <- data.frame(fixef(brms_11, summary = T))
write.csv(Table11, file = here("./Data/Output/Model11_summary.csv"))

```


```{r echo=FALSE}
Plot_brms(SizeHabitatModel, pglsMod8)
```

3. STAN Model


```{r echo=FALSE}
kbl(fit11_summary, caption = 'STAN model 8 summary', booktabs = T, linesep = "")%>% 
  kable_styling(latex_options = c("scale_down","hold_postion","striped"), full_width = T)
```

```{r echo=FALSE}
Plot_stan(posterior11, SizeHabitatModel, pglsMod8)
```


### BRMS LOO analysis

LOO compare
```{r echo=FALSE}
fit6_loo <- loo(Model_simple)
fit7_loo <- loo(Model_BS)
fit8_loo <- loo(Model_BS2)
fit9_loo <- loo(HabitatPhylo)
fit10_loo <- loo(HabitatPhylo2)
fit11_loo <- loo(SizeHabitatModel)

brms_loo_phylo_list <- list(fit6_loo, fit7_loo, fit8_loo, fit9_loo, fit10_loo, fit11_loo)
brms_loo_phylo <- loo_compare(brms_loo_phylo_list)
kbl(brms_loo_phylo, booktabs = T, linesep = "") %>% 
  kable_styling(latex_options = c("hold_postion","scale_down","striped"), full_width = T)
```

LOO model weights
```{r}
loo_model_weights(brms_loo_phylo_list)

```

