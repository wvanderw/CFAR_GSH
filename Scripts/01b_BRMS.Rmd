---
title: "01b_BRMS"
author: "Wade VanderWright"
date: '2022-03-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#01_b -- BRMS Models for Ch. 1
## VanderWright, WJ
## May 27, 2022
## Updated: November 1, 2022

## Model 1 - GSH ~ CFAR

```{r}
brms_1_prior <- get_prior(Log10MeanGSH_centered ~ Log10CFAR_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    data2 = list(B = B),
                    family = gaussian())


brms_1 <- brm(Log10MeanGSH_centered ~ Log10CFAR_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    data2 = list(B = B),
                    family = gaussian(),
                    prior = brms_1_prior,
                    warmup = 1000, iter = 5000,
                    cores = 4
                    )

summary(brms_1)
```

```{r}
plot(conditional_effects(brms_1), points = TRUE)

```

## Model 2 - GSH ~ Max Size
```{r}
brms_2_prior <- get_prior(Log10MeanGSH_centered ~ Log10MaxSize_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    data2 = list(B = B),
                    family = gaussian())

brms_2 <- brm(Log10MeanGSH_centered ~ Log10MaxSize_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    data2 = list(B = B),
                    family = gaussian(),
                    prior = brms_2_prior,
                    warmup = 1000, iter = 5000,
                    cores = 4
                    )

summary(brms_2)

```


```{r}
plot(conditional_effects(brms_2), points = TRUE) #hit enter in the console

```

## Model 3 - GSH ~ PrimaryHabitat
```{r}
brms_3_prior <- get_prior(Log10MeanGSH_centered ~ PrimaryHabitat + (1 | gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    data2 = list(B = B),
                    family = gaussian())

brms_3 <- brm(Log10MeanGSH_centered ~ PrimaryHabitat + (1 | gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    data2 = list(B = B), 
                    family = gaussian(),
                    prior = brms_3_prior,
                    warmup = 1000, iter = 5000,
                    cores = 4)

summary(brms_3)
```

```{r}
plot(conditional_effects(brms_3), points = TRUE) #hit enter in the console



```

## Model 4 - GSH ~ Max Depth
```{r}
brms_4_prior <- get_prior(Log10MeanGSH_centered ~ Log10DepthMax_centered + (1 | gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    data2 = list(B = B),
                    family = gaussian())

#run time was about 30 minutes
brms_4 <- brm(Log10MeanGSH_centered ~ Log10DepthMax_centered + (1 | gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    data2 = list(B = B),
                    family = gaussian(),
                    prior = brms_4_prior,
                    cores = 4, warmup = 1000,
                    iter = 5000)

summary(brms_4)


```


```{r}
plot(conditional_effects(brms_4), points = TRUE)

```

```{r}
plot(brms_4, N=2, ask = F)
```


## Model 5 - GSH ~ Min Depth
```{r}
brms_5_prior <- get_prior(Log10MeanGSH_centered ~ Log10DepthMin_centered + (1 | gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    data2 = list(B = B),
                    family = gaussian())

#run time was about 30 minutes
brms_5 <- brm(Log10MeanGSH_centered ~ Log10DepthMin_centered + (1 | gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    data2 = list(B = B),
                    family = gaussian(),
                    prior = brms_5_prior,
                    warmup = 1000, iter = 5000,
                    cores = 4)

summary(brms_5)


```


```{r}
plot(conditional_effects(brms_5), points = TRUE, ask = F)
```

```{r}
plot(brms_5, N=2, ask = F)

```



## Model 6 - GSH ~ Median Depth 
```{r}
brms_6_prior <- get_prior(Log10MeanGSH_centered ~ Log10DepthMedian_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B))

#run time was about 30 minutes
brms_6 <- brm(Log10MeanGSH_centered ~ Log10DepthMedian_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B),
                    prior = brms_6_prior,
                    cores = 4,
                    warmup = 1000, iter = 5000)

summary(brms_6)


```


```{r}
plot(conditional_effects(brms_6), points = TRUE)

```

```{r}
plot(brms_6, N=2, ask = F)

```


```{r}
#lamda estimate
hyp <- "sd_Binomial__Intercept^2 / (sd_Binomial__Intercept^2 + sigma^2) = 0"
(hyp <- hypothesis(brms_6, hyp, class = NULL))
```

```{r}
plot(hyp)
```

## Model 7 - GSH ~ Habitat Area
```{r}
brms_7_prior <- get_prior(Log10MeanGSH_centered ~ Log10Area_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B))

brms_7 <- brm(Log10MeanGSH_centered ~ Log10Area_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B),
                    prior = brms_7_prior,
                    chains = 4, cores = 4,
                    warmup = 1000, iter = 5000)

summary(brms_7)
```

```{r}
plot(conditional_effects(brms_7), points = TRUE, ask = F) 

```

```{r}
plot(brms_7, N=2, ask = F)
```







## Model 8 - CFAR ~ GSH + Max Size + Habitat
```{r}
brms_8_prior <- get_prior(Log10MeanGSH_centered ~ Log10CFAR_centered + Log10MaxSize_centered + PrimaryHabitat + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B))

brms_8 <- brm(Log10MeanGSH_centered ~ Log10CFAR_centered + Log10MaxSize_centered + PrimaryHabitat + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B),
                    prior = brms_8_prior,
                    chains = 4, cores = 4,
                    warmup = 1000, iter = 5000)

summary(brms_8)
```

```{r}
plot(conditional_effects(brms_8), points = TRUE, ask = F)
```

```{r}
plot(brms_8, N=2, ask = F)
```


```{r}
hyp <- 'sd_Binomial__Intercept^2 / (sd_Binomial__Intercept^2 + sigma^2) = 0'
(hyp <- hypothesis(brms_8, hyp, class = NULL))
plot(hyp)
```


## Model 9 - CFAR ~ GSH + MaxSize + Median Depth
```{r}
brms_9_prior <- get_prior(Log10MeanGSH_centered ~ Log10CFAR_centered + Log10MaxSize_centered + Log10DepthMedian_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B))

brms_9 <- brm(Log10MeanGSH_centered ~ Log10CFAR_centered + Log10MaxSize_centered + Log10DepthMedian_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B),
                    prior = brms_9_prior,
                    chains = 4, cores = 4,
                    warmup = 1000, iter = 5000)

summary(brms_9)
```

```{r}
conditions <- data.frame(Log10DepthMedian_centered = c(-1, 0, 1))
plot(conditional_effects(brms_9, effects = "Log10CFAR_centered:Log10MaxSize_centered",
                         conditions = conditions, int_conditions = list(Log10MaxSize_centered = c(-1, 0, 1)), spaghetti = TRUE, ndraws = 1000), points = TRUE)

#plot(conditional_effects(brms_9), points = TRUE, ask = FALSE)
```

```{r}
plot(conditional_effects(brms_9), points = TRUE, ask = FALSE)
```


## Model 10 - CFAR ~ GSH + MaxSize + Area
```{r}
brms_10_prior <- get_prior(Log10MeanGSH_centered ~ Log10CFAR_centered + Log10MaxSize_centered + Log10Area_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B))

brms_10 <- brm(Log10MeanGSH_centered ~ Log10CFAR_centered + Log10MaxSize_centered + Log10Area_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B),
                    prior = brms_10_prior,
                    chains = 4, cores = 4,
                    warmup = 1000, iter = 5000)

summary(brms_10)
```

```{r}
plot(conditional_effects(brms_10), points = TRUE, ask = FALSE)

```


## Model 11 - CFAR ~ MaxSize + PrimaryHabitat + Phylogeny
```{r}
brms_11_prior <- get_prior(Log10MeanGSH_centered ~ Log10MaxSize_centered + PrimaryHabitat + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B))

brms_11 <- brm(Log10MeanGSH_centered ~ Log10MaxSize_centered + PrimaryHabitat + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B),
                    prior = brms_11_prior,
                    chains = 4, cores = 4,
                    warmup = 1000, iter = 5000)

summary(brms_11)
```

```{r}
plot(conditional_effects(brms_11), points = TRUE, ask = F)
```


```{r}
plot(brms_11, points = TRUE, ask = F)
```

```{r}
hyp <- 'sd_Binomial__Intercept^2 / (sd_Binomial__Intercept^2 + sigma^2) = 0'
(hyp <- hypothesis(brms_11, hyp, class = NULL))
plot(hyp)
```

##Model 12 -- GSH ~ CFAR * MaxSize + PrimaryHabitat + Phylogeny
```{r}
BRMS_12_prior <- get_prior(Log10MeanGSH_centered ~ Log10CFAR_centered * Log10MaxSize_centered + PrimaryHabitat + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B))

BRMS_12_Model <- brm(Log10MeanGSH_centered ~ Log10CFAR_centered * Log10MaxSize_centered + PrimaryHabitat + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B),
                    prior = BRMS_12_prior,
                    chains = 4, cores = 4,
                    warmup = 1000, iter = 5000)

summary(BRMS_12_Model)
```

```{r}
plot(conditional_effects(BRMS_12_Model), points = TRUE, ask = F)
```


```{r}
plot(BRMS_12_Model)

```


##Model 13 -- CFAR ~ GSH * PrimaryHabitat + MaxSize + Phylogeny
```{r}
brms_13_prior <- get_prior(Log10MeanGSH_centered ~ Log10CFAR_centered * Log10MaxSize_centered + Log10DepthMedian_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B))

brms_13 <- brm(Log10MeanGSH_centered ~ Log10CFAR_centered * Log10MaxSize_centered + Log10DepthMedian_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B),
                    prior = brms_13_prior,
                    chains = 4, cores = 4,
                    warmup = 1000, iter = 5000)

summary(brms_13)
```

```{r}
plot(conditional_effects(brms_13), points = T, ask = F)
```

```{r}
plot(brms_13, points = TRUE, ask = FALSE)
```

## Model 14 - GSH ~ MaxSize + Depth
```{r}
brms_14_prior <- get_prior(Log10MeanGSH_centered ~ Log10MaxSize_centered + Log10DepthMedian_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B))

brms_14 <- brm(Log10MeanGSH_centered ~ Log10MaxSize_centered + Log10DepthMedian_centered + (1|gr(Binomial, cov = B)),
                    data = GSH_df_pgls,
                    family = gaussian(),
                    data2 = list(B = B),
                    prior = brms_14_prior,
                    chains = 4, cores = 4,
                    warmup = 1000, iter = 5000)

summary(brms_14)
```



##LOO comapre (quick and dirty version)

```{r}
fit1_loo <- loo(brms_1)
fit2_loo <- loo(brms_2)
fit3_loo <- loo(brms_3)
fit4_loo <- loo(brms_4)
fit5_loo <- loo(brms_5)

#brms_loo_nonphylo_list <- list(fit1_loo, fit2_loo, fit3_loo, fit4_loo, fit5_loo)
#brms_loo_nonphylo <- loo_compare(brms_loo_nonphylo_list)
#loo_model_weights(brms_loo_nonphylo_list)

fit6_loo <- loo(brms_6) #31, 74, 157, 183, 336, 451
fit7_loo <- loo(brms_7)
fit8_loo <- loo(brms_8)
fit9_loo <- loo(brms_9)
fit10_loo <- loo(brms_10)
fit11_loo <- loo(brms_11)
fit12_loo <- loo(BRMS_12_Model)
fit13_loo <- loo(brms_13)
fit14_loo <- loo(brms_14)

brms_loo_phylo_list <- list(fit1_loo, fit2_loo, fit3_loo, fit4_loo, fit5_loo, fit6_loo, fit7_loo, fit8_loo, fit9_loo, fit10_loo, fit11_loo, fit12_loo, fit13_loo, fit14_loo)
brms_loo_phylo <- loo_compare(brms_loo_phylo_list)
loo_model_weights(brms_loo_phylo_list)

LOO_Table <- as.data.frame(brms_loo_phylo, simplify = FALSE, digits = 3)

write.csv(LOO_Table, file = here("./Data/Output/LOO_Table.csv"), row.names = T)

brms_loo_phylo
```

## Summary of best model
```{r}
Table_9 <- data.frame(fixef(brms_9, summary = TRUE))
write.csv(Table_9, file = here("./Data/Output/Model9_summary.csv"))
```



### Save the environment
```{r}
save.image(here('./Data/Output/CurrentDataState.RData'))

```



