---
title: "Diagnostics"
author: "Wade VanderWright"
date: '2022-03-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Physical specimen Plots
##Multi specimen plot
```{r}
#create new df for plotting
library(forcats)

df <- as_tibble(PhysSpec_mutli)
df <- df[,c(2:ncol(df))]
df$Binomial <- str_replace(df$Binomial, "_", " ")

#GSH plot
P1 <- df %>% 
  mutate(Binomial = fct_reorder(Binomial, desc(MeanGSH), .fun = 'median')) %>% 
  ggplot(aes(x = Binomial, y =  value.x)) +
  geom_boxplot() +
  geom_point(aes(x = Binomial, y = MeanGSH), data = df, color = 'red') +
  ylim(0.0,0.11) +
  theme_light() +
  annotate("text", x = 30, y = 0.08, label = "16/32 = 50%") +
    coord_flip() +
  xlab("Species") +
theme(axis.text.x = element_blank(),
      axis.title.x = element_blank(),
      axis.text.y = element_text(face = 'italic'),
      panel.grid = element_blank())


P1

16/32

#CFAR plot

P2 <- df %>% 
  mutate(Binomial = fct_reorder(Binomial, desc(MeanGSH), .fun = 'median')) %>% 
  ggplot(aes(x = Binomial, y = value.y, drop = TRUE)) +
  geom_boxplot() +
  geom_point(aes(x = Binomial, y = CaudalAspect_proportion_TL), data = df, color = 'red') +
  ylim(0,8) +
  ylab("CFAR") +
  xlab("Species") +
  annotate("text", x = 30, y = 6, label = "26/29 = 90%") +
      coord_flip() +
  theme_light() +
  theme(axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        panel.grid = element_blank())

P2

#26/29 *
  


library(patchwork)

P_multi <- P1 | P2
P_multi
```

##Single specimen plot
```{r}
df2 <- as_tibble(PhysSpec_singles)
df2$Binomial <- str_replace(df2$Binomial, "_", " ")

#GSH plot
P3 <- df2 %>% 
  mutate(Binomial = fct_reorder(Binomial, desc(MeanGSH))) %>% 
  ggplot(aes(x = Binomial, y = MeanGSHPropTL)) +
  geom_segment(aes(xend = Binomial, y = MeanGSHPropTL_upperCI, yend = MeanGSHPropTL_lowerCI), lineend = "butt", color = 'grey', size = 2) +
  geom_segment(aes(xend = Binomial, y = MeanGSHPropTL_maxCI, yend = MeanGSHPropTL_minCI), 
               lineend = "butt", color = 'grey') +
  geom_point() +
  geom_point(aes(x = Binomial, y = MeanGSH), data = df2, color = 'red') +
  ylim(0.0,0.11) +
  ylab("Mean Gill Slit Height") +
  xlab("Species") +
  annotate("text", x = 16, y = 0.08, label = "12/17 = 71%") +
  coord_flip() +
  theme_light() +
  theme(#axis.text.x = element_blank(),
        axis.text.y = element_text(face = 'italic'),
        #axis.title.x = element_blank(),
        #axis.title.y = element_blank(),
        panel.grid = element_blank()) 
P3

#10/17

#CFAR plot

P4 <- df2 %>% 
  mutate(Binomial = fct_reorder(Binomial, desc(MeanGSH))) %>%
  ggplot(aes(x = Binomial, y = CFAR, drop = TRUE)) +
  geom_segment(aes(xend = Binomial, y = CFAR_upperCI, yend = CFAR_lowerCI), lineend = "butt", color = 'grey', size = 2) +
  geom_segment(aes(xend = Binomial, y = CFAR_maxCI, yend = CFAR_minCI), lineend = "butt", color = 'grey') +
  geom_point() +
  geom_point(aes(x = Binomial, y = CaudalAspect_proportion_TL), data = df2, color = 'red') +
  ylim(0,8) +
  xlab("Species") +
  annotate("text", x = 16, y = 6, label = "17/17 = 100%") +
  coord_flip() +
  theme_light() +
  theme(axis.text.y = element_blank(),
        #axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid = element_blank())

P4


P_singles <- P3 | P4
P_singles
```

##Stitch them together
```{r}
Fig1 <- P_multi / P_singles +
  plot_annotation(tag_levels = 'A')
Fig1


png(here('./Data/Output/Figure1_PhysicalSpecimens_draft.png'), width = 20, height = 30,
    units = "cm", res = 800, bg = "transparent")

Fig1

dev.off()
```


#PCA Plots


#BRMS output plots
```{r}


color_scheme_set("mix-blue-pink")
p <- mcmc_trace(brms_11, pars = c("b_Intercept","b_Log10MeanGSH_centered","b_Log10MaxSize_centered","b_PrimaryHabitat2",                                      
                                  "b_PrimaryHabitat3","b_Log10MeanGSH_centered:Log10MaxSize_centered","sd_Binomial__Intercept",
                                  "sigma"), n_warmup = 1000,
                facet_args = list(nrow = 2, labeller = label_parsed))
p + facet_text(size = 15)
```

```{r}
posterior11_c <- as.matrix(brms_11)
color_scheme_set('purple')

dimnames(posterior11_c)[[2]] <- c("alpha", "beta", "MaxSize", "Deepwater", "Pelagic", "GSH:MaxSize", "sigma", "lambda", "log_lik", "lp__") 


mcmcareaplot <- mcmc_areas(posterior11_c, pars = c("alpha", "beta", "sigma", "lambda"), prob = 0.95)
 ggsave(here('./Data/Output/MCMC_Area_plot1.pdf'), mcmcareaplot, device = 'pdf', height = 6, width = 8, units = 'in')

mcmcareaplot <- mcmcareaplot +
  theme_transparent()

png(here('./Data/Output/MCMC_Area_plot2.png'), width = 20, height = 15,
    units = "cm", res = 800, bg = "transparent")

mcmcareaplot

dev.off()
 
```

```{r}
color_scheme_set("brightblue")
brms_11 %>%
  posterior_predict(draws = 500) %>%
  ppc_stat_grouped(y = GSH_df_pgls$Log10CFAR_centered,
                   group = GSH_df_pgls$PrimaryHabitat,
                   stat = "mean")
```

```{r}

###bae plot###
color_scheme_set('brightblue')
bayesplot_theme_set(theme_transparent())

PPC_plot1 <- ppc_intervals(
  y = GSH_df_pgls$Log10CFAR,
  yrep = posterior_predict(brms_11),
  x = as.numeric(GSH_df_pgls$Log10MeanGSH_centered),
  prob = 0.5, prob_outer = 0.95
) +
  labs(
    x = "Log10 Mean GSH",
    y = "Log10 CFAR",
    title = "95% posterior predictive intervals \nvs observed CFAR",
  ) 



### coastal ranges###
coastal_spp <- GSH_df_pgls %>% 
  filter(PrimaryHabitat == 'Coastal') %>% 
  arrange(Log10MeanGSH_centered)

coastal_spp_range <- c(as.numeric(coastal_spp[1,36]), as.numeric(coastal_spp[198,36]), as.numeric(coastal_spp[1,37]), as.numeric(coastal_spp[198,37]))

coastal_ystart = coastal_spp_range[1]*fit11_summary[2,1] + #GSH slope
                 coastal_spp_range[3]*fit11_summary[3,1] + #Size slope
                 fit11_summary[6,1]*coastal_spp_range[1]*coastal_spp_range[3] + #interaction 
                 fit11_summary[1,1] #intercept
  
coastal_yend = coastal_spp_range[2]*fit11_summary[2,1] + 
               coastal_spp_range[4]*fit11_summary[3,1] + 
               fit11_summary[6,1]*coastal_spp_range[2]*coastal_spp_range[4] + 
               fit11_summary[1,1]

PPCplot1 <- PPC_plot1 + geom_abline(intercept = fit11_summary[1,1], slope = fit11_summary[2,1] )

PPC_plot1 <- PPC_plot1 + geom_segment(x = coastal_spp_range[1], xend = coastal_spp_range[2], y = coastal_ystart, yend = coastal_yend, color = 'orange')

###deepwater###
deepwater_spp <- GSH_df_pgls %>% 
  filter(PrimaryHabitat == 'Deepwater') %>% 
  arrange(Log10MeanGSH_centered)

deepwater_spp_range <- c(as.numeric(deepwater_spp[1,36]), as.numeric(deepwater_spp[232,36]), as.numeric(deepwater_spp[1,37]), as.numeric(deepwater_spp[232,37]))

deepwater_ystart = deepwater_spp_range[1]*fit11_summary[2,1] + 
  deepwater_spp_range[3]*fit11_summary[3,1] + 
  fit11_summary[4,1]*deepwater_spp_range[1] + 
  fit11_summary[6,1]*deepwater_spp_range[1]*deepwater_spp_range[3] + 
  fit11_summary[1,1]
  
deepwater_yend = deepwater_spp_range[2]*fit11_summary[2,1] + deepwater_spp_range[4]*fit11_summary[3,1] + fit11_summary[6,1]*deepwater_spp_range[2]*deepwater_spp_range[4] + fit11_summary[1,1]


PPC_plot1 <- PPC_plot1 + geom_segment(x = deepwater_spp_range[1], xend = deepwater_spp_range[2], y = deepwater_ystart, yend = deepwater_yend, color = 'green')
PPC_plot1

###pelagic###
pelagic_spp <- GSH_df_pgls %>% 
  filter(PrimaryHabitat == 'Pelagic')

pelagic_spp_range <- c(min(as.numeric(pelagic_spp$Log10MeanGSH_centered)), max(as.numeric(pelagic_spp$Log10MeanGSH_centered)), min(pelagic_spp$Log10MaxSize_centered), max(pelagic_spp$Log10MaxSize_centered))

pelagic_ystart = pelagic_spp_range[1]*fit11_summary[2,1] + pelagic_spp_range[3]*fit11_summary[3,1] + fit11_summary[6,1]*pelagic_spp_range[1]*pelagic_spp_range[3] + fit11_summary[1,1]
  
pelagic_yend = pelagic_spp_range[2]*fit11_summary[2,1] + pelagic_spp_range[4]*fit11_summary[3,1] + fit11_summary[6,1]*pelagic_spp_range[2]*pelagic_spp_range[4] + fit11_summary[1,1]

PPC_plot1 <- PPC_plot1 + geom_segment(x = pelagic_spp_range[1], xend = pelagic_spp_range[2], y = pelagic_ystart, yend = pelagic_yend, color = 'blue')
PPC_plot1

ggsave(here('./Data/Output/PPC_plot1.png'), PPC_plot1, device = 'png', height = 6, width = 8, units = 'in')

```

```{r}
Prez_plot <- GSH_df_pgls %>% 
  data_grid(Log10MeanGSH_centered = seq_range(Log10MeanGSH_centered, 100), Binomial, Log10MaxSize_centered, PrimaryHabitat) %>% 
  add_epred_draws(brms_11, ndraws = 10) %>% 
  ggplot(aes(x = Log10MeanGSH_centered, y = Log10CFAR_centered, color = PrimaryHabitat), fill = PrimaryHabitat) +
  stat_lineribbon(aes(y = .prediction), .width = c(.95, .80, .50), alpha = .25)+
  geom_point(data = GSH_df_pgls)+
  scale_fill_brewer(palette = 'Greys')+
  scale_colour_brewer(palette = 'Set2')
```



```{r}
ppd_dens_overlay(ypred = yrep[1:100, ])
```


```{r}
PPC_plot2 <- ppc_dens_overlay(y = GSH_df_pgls$Log10CFAR_centered, yrep = yrep[1:50, ], alpha = 0.25) +
  geom_vline(xintercept = mean(y), color = "#023858") +
  theme_transparent()

ggsave(here('./Data/Output/PPC_plot2.png'), PPC_plot2, device = 'png', height = 6, width = 8, units = 'in')

G <- GSH_df_pgls$PrimaryHabitat

PPC_plot3 <- ppc_dens_overlay_grouped(y = GSH_df_pgls$Log10CFAR, yrep = yrep[1:50, ], alpha = 0.25, group = G ) +
  theme_transparent()

ggsave(here('./Data/Output/PPC_plot3.png'), PPC_plot3, device = 'png', height = 6, width = 8, units = 'in')

PPC_plot4 <- ppc_stat_grouped(y = GSH_df_pgls$Log10CFAR, yrep = yrep, group = G, stat = 'mean') +
  theme_transparent()

ggsave(here('./Data/Output/PPC_plot4.png'), PPC_plot4, device = 'png', height = 6, width = 12, units = 'in')

```

```{r}
ppd_intervals(ypred = yrep, prob = 0.5, prob_outer = 0.95, x = as.numeric(GSH_df_pgls$Log10MeanGSH_centered))+
  labs(
    x = "Log10 Mean GSH",
    y = "Log10 CFAR",
    title = "95% posterior predictive intervals \nvs observed CFAR",
    subtitle = "by mean GSH (proportion total length)"
  ) 
```


```{r}
loo11 <- loo(SizeHabitatModel, save_psis = TRUE, cores = 4)

y <- GSH_df_pgls$Log10CFAR
yrep <- posterior_predict(SizeHabitatModel)
```

```{r}
psis11 <- loo11$psis_object
lw <- weights(psis11)
```

```{r}
color_scheme_set('purple')
ppc_loo_pit_overlay(y, yrep, lw = lw)
```

```{r}
ppc_loo_pit_qq(y, yrep, lw = lw, compare = 'normal')
```
```{r}
keep_obs <- c(1:100)

ppc_loo <- ppc_loo_intervals(y, yrep, psis_object = psis11, subset = keep_obs, order = 'median', prob = 0.95)

ggsave(here('./Data/Output/PPC_LOO_plot1.pdf'), ppc_loo, device = 'pdf', height = 6, width = 8, units = 'in')
```


```{r}
set.seed(11)

grid = data.frame(GSH_df_pgls)
  
means = grid %>%
  add_epred_draws(brms_11)

preds = grid %>%
  add_predicted_draws(brms_11)

ppc_habitat <- GSH_df_pgls %>%
  ggplot(aes(x = Log10CFAR_centered, y = PrimaryHabitat)) +
  stat_halfeye(aes(x = .epred), scale = 0.6, position = position_nudge(y = 0.175), data = means) +
  stat_interval(aes(x = .prediction), data = preds) +
  geom_point(data = GSH_df_pgls) +
  scale_color_brewer() +
  theme_bw()

ggsave(here('./Data/Output/PPC_Habitats_v1.png'), ppc_habitat, device = 'png', height = 6, width = 10, units = 'in')


ppc_habitat
```

```{r}
post_11 <- posterior_samples(brms_11)

post_11 %>% 
  ggplot(aes(x = b_Intercept, y = 0)) +
  stat_halfeye() +
  scale_y_continuous(NULL, breaks = NULL)


```

```{r}



plot_11 <- ggplot(aes(x = Log10MeanGSH_centered, y = Log10CFAR_centered,  color = PrimaryHabitat), data = GSH_df_pgls) 
  

#coastal
  for (i in 1:500) {
 plot_11 <- plot_11 + geom_abline(intercept = fixef(brms_11, summary = F)[i,1], slope = fixef(brms_11, summary = F)[i,2], color = adjustcolor("#d95f02", alpha = 0.05), lty = 1) 
} 

#deepwater
  for (i in 501:1000) {
 plot_11 <- plot_11 + geom_abline(intercept = fixef(brms_11, summary = F)[i,4], slope = fixef(brms_11, summary = F)[i,2], color = adjustcolor("#7570b3", alpha = 0.05), lty = 1) 
} 

#pelagic
  for (i in 1001:1500) {
 plot_11 <- plot_11 + geom_abline(intercept = fixef(brms_11, summary = F)[i,5], slope = fixef(brms_11, summary = F)[i,2], color = adjustcolor("#1b9e77", alpha = 0.05), lty = 1) 
} 

#coastal
plot_11 <- plot_11 + geom_abline(intercept = fixef(brms_11)[1,1], slope = fixef(brms_11)[2,1], color = '#d95f02', size = 1.5)
#deepwater
plot_11 <- plot_11 + geom_abline(intercept = fixef(brms_11)[4,1], slope = fixef(brms_11)[2,1], color = '#7570b3', size = 1.5)
#pelagic
plot_11 <- plot_11 + geom_abline(intercept = fixef(brms_11)[5,1], slope = fixef(brms_11)[2,1], color = '#1b9e77', size = 1.5)


plot_11 <- plot_11 + geom_point(alpha = 0.5) +
  scale_color_manual(values = c("Coastal" = "#d95f02",
                                "Deepwater" = "#7570b3",
                                "Pelagic" = "#1b9e77")) +
  theme_bw()+
  ggtitle(paste("Correlation=", cor(GSH_df_pgls$Log10CFAR, GSH_df_pgls$Log10MeanGSH_centered)))+
       xlab("Log10 GSH (proportion of TL)")+
       ylab("Log10 CFAR") 
  


plot_11

ggsave(here('./Data/Output/Model11_plot.png'), plot_11, height = 20, width = 30, units = 'cm')


```



```{r}
library(insight)
library(bayestestR)
library(patchwork)
# S3 method for brmsfit
brms_11_post <- get_parameters(
  brms_11,
  effects = "fixed",
  component = "all",
  parameters = NULL,
  summary = FALSE,
  centrality = "mean"
)

head(brms_11_post)

brms_11_CI <- ci(brms_11, method = "HDI", component = 'all')

brms_11_CI$CI_low[1]


out <- estimate_density(brms_11_post, extend = T, select = 'b_Intercept')

#intercept - coastal
out_IC <- estimate_density(brms_11_post, extend = T, select = 'b_Intercept')

I_C <- ggplot(out_IC, aes(x = x, y = y)) +
  geom_area(fill = '#7570b3')+
  geom_vline(xintercept = brms_11_CI$CI_low[1], color = '#1b9e77', size = 1, alpha = 0.3)+
  geom_vline(xintercept = brms_11_CI$CI_high[1], color = '#1b9e77', size = 1, alpha = 0.3) +
  xlim(-1, 1) +
  ylim(0,22) +
  ylab(element_blank()) +
  xlab(element_blank()) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

I_C

#intercept - deepwater
out_ID <- estimate_density(brms_11_post, extend = T, select = 'b_PrimaryHabitat2')

I_D <- ggplot(out_ID, aes(x = x, y = y)) +
  geom_area(fill = '#7570b3')+
  geom_vline(xintercept = brms_11_CI$CI_low[4], color = '#1b9e77', size = 1, alpha = 0.3)+
  geom_vline(xintercept = brms_11_CI$CI_high[4], color = '#1b9e77', size = 1, alpha = 0.3) +
  xlim(-1, 1) +
  ylim(0,22) +
  ylab(element_blank()) +
  xlab(element_blank()) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())


I_D
#intercept - pelagic
out_IP <- estimate_density(brms_11_post, extend = T, select = 'b_PrimaryHabitat3')

I_P <- ggplot(out_IP, aes(x = x, y = y)) +
  geom_area(fill = '#7570b3')+
  geom_vline(xintercept = brms_11_CI$CI_low[5], color = '#1b9e77', size = 1, alpha = 0.3)+
  geom_vline(xintercept = brms_11_CI$CI_high[5], color = '#1b9e77', size = 1, alpha = 0.3) +
  xlim(-1, 1) +
  ylim(0,22) +
  ylab(element_blank()) +
  xlab(element_blank()) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())


I_P
#slope - CFAR ~ GSH
out_SG <- estimate_density(brms_11_post, extend = T, select = 'b_Log10MeanGSH_centered')

S_G <- ggplot(out_SG, aes(x = x, y = y)) +
  geom_area(fill = '#7570b3')+
  geom_vline(xintercept = brms_11_CI$CI_low[2], color = '#1b9e77', size = 1, alpha = 0.3)+
  geom_vline(xintercept = brms_11_CI$CI_high[2], color = '#1b9e77', size = 1, alpha = 0.3) +
  xlim(-1, 1) +
  ylim(0,22) +
  ylab(element_blank()) +
  xlab(element_blank()) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

S_G
#slope - CFAR ~ Size
out_SS <- estimate_density(brms_11_post, extend = T, select = 'b_Log10MaxSize_centered')

S_S <- ggplot(out_SS, aes(x = x, y = y)) +
  geom_area(fill = '#7570b3')+
  geom_vline(xintercept = brms_11_CI$CI_low[3], color = '#1b9e77', size = 1, alpha = 0.3)+
  geom_vline(xintercept = brms_11_CI$CI_high[3], color = '#1b9e77', size = 1, alpha = 0.3) +
  xlim(-1, 1) +
  ylim(0,22) +
  ylab(element_blank()) +
  xlab(element_blank()) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

S_S
#interaction GSH:Size
out_GS <- estimate_density(brms_11_post, extend = T, select = 'b_Log10MeanGSH_centered:Log10MaxSize_centered')

Int_GS <- ggplot(out_GS, aes(x = x, y = y)) +
  geom_area(fill = '#7570b3')+
  geom_vline(xintercept = brms_11_CI$CI_low[6], color = '#1b9e77', size = 1, alpha = 0.3)+
  geom_vline(xintercept = brms_11_CI$CI_high[6], color = '#1b9e77', size = 1, alpha = 0.3) +
  xlim(-1, 1) +
  ylim(0,22) +
  ylab(element_blank()) +
  xlab(element_blank()) +
  theme_bw()  +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

Int_GS
#sigma
out_sigma <- estimate_density(brms_11_post, extend = T, select = 'sigma')


SIG <- ggplot(out_sigma, aes(x = x, y = y)) +
  geom_area(fill = '#7570b3')+
  geom_vline(xintercept = brms_11_CI$CI_low[7], color = '#1b9e77', size = 1, alpha = 0.3)+
  geom_vline(xintercept = brms_11_CI$CI_high[7], color = '#1b9e77', size = 1, alpha = 0.3) +
  xlim(-1, 1) +
  ylim(0,22) +
  ylab(element_blank()) +
  xlab(element_blank()) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())


SIG

HYP <- plot(hyp)


panel_plot <- I_C + I_D + I_P + S_G + S_S + Int_GS + SIG + plot_layout(ncol = 1)

panel_plot2 <- plot_11 + panel_plot + plot_layout(widths = c(2,1)) + plot_annotation(tag_levels = 'a')


ggsave(here('./Data/Output/Fig1_Draft.png'), panel_plot2, height = 20, width = 35, units = 'cm')


```


```{r}
boxplot <- ggplot(GSH_df_pgls, aes(x = PrimaryHabitat, y = Log10CFAR_centered), colour = PrimaryHabitat)+
  geom_boxplot(aes(fill = PrimaryHabitat), alpha = 0.3) +
  geom_point(aes(colour = PrimaryHabitat)) +
  scale_color_manual(values = c("Coastal" = "#d95f02",
                                "Deepwater" = "#7570b3",
                                "Pelagic" = "#1b9e77")) +
  scale_fill_manual(values = c("Coastal" = "#d95f02",
                                "Deepwater" = "#7570b3",
                                "Pelagic" = "#1b9e77")) +
  theme_light()
  

boxplot

ggsave(here('./Data/Output/boxplot_habitat.png'), boxplot, height = 20, width = 30, units = 'cm')

```

